<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>網站後台管理系統 | 未來科技</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        :root {
            --color-dark-bg: #0A0A0A;
            --color-primary: #00FFFF;
            --color-secondary: #0077B6;
            --color-text-light: #F0F0F0;
            --color-text-dim: #AAAAAA;
            --color-danger: #FF6B6B;
            --color-success: #4CAF50;
            --color-warning: #FFC107;
            --sidebar-width: 250px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: var(--color-dark-bg); color: var(--color-text-light); line-height: 1.6; }
        a { color: var(--color-primary); text-decoration: none; }
        h2 { color: var(--color-primary); margin-bottom: 20px; border-bottom: 2px solid var(--color-secondary); padding-bottom: 10px; }
        h3 { color: var(--color-text-light); margin-top: 25px; margin-bottom: 15px; border-bottom: 1px dashed #333; padding-bottom: 5px;}

        /* 主要佈局 */
        .admin-layout { display: flex; min-height: 100vh; }

        /* 側邊欄 */
        .sidebar {
            width: var(--sidebar-width); background-color: #1A1A1A; padding: 20px;
            flex-shrink: 0; border-right: 1px solid var(--color-secondary);
            display: flex; flex-direction: column;
        }
        .sidebar h1 { color: var(--color-text-light); font-size: 1.5em; text-align: center; margin-bottom: 30px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .sidebar nav { flex-grow: 1; }
        .sidebar nav ul { list-style: none; }
        .sidebar nav ul li { margin-bottom: 5px; }
        .sidebar nav ul li a {
            display: block; padding: 10px 15px; color: var(--color-text-dim); font-weight: bold;
            border-radius: 5px; transition: background-color 0.2s, color 0.2s;
        }
        .sidebar nav ul li a i { margin-right: 10px; width: 20px; text-align: center; }
        .sidebar nav ul li a:hover { background-color: #2A2A2A; color: var(--color-text-light); }
        .sidebar nav ul li a.active { background-color: var(--color-secondary); color: white; }
        /* 登出按鈕 */
        .logout-section a {
            background-color: var(--color-danger); color: white; text-align: center;
        }
        .logout-section a:hover { background-color: #ff8b8b; }

        /* 主要內容區 */
        .main-content { flex-grow: 1; padding: 30px; overflow-x: hidden; }
        .tab-content { display: none; animation: fadeIn 0.5s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* 頂部操作欄 */
        .content-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;}
        .search-bar { display: flex; gap: 10px; }

        /* 按鈕 */
        .btn {
            padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer;
            font-weight: bold; transition: all 0.2s;
        }
        .btn-primary { background-color: var(--color-success); color: white; }
        .btn-secondary { background-color: var(--color-secondary); color: white; }
        .btn-danger { background-color: var(--color-danger); color: white; }
        .btn-warning { background-color: var(--color-warning); color: black; }
        .btn:hover { opacity: 0.8; }
        .btn i { margin-right: 5px; }
        
        .btn-edit { background-color: var(--color-warning); color: black; padding: 5px 10px; font-size: 0.9em;}
        .btn-delete { background-color: var(--color-danger); color: white; padding: 5px 10px; font-size: 0.9em;}

        /* 表格 */
        .table-responsive { overflow-x: auto; }



        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .data-table th, .data-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #222; }
        .data-table th { background-color: #1A1A1A; color: var(--color-primary); }
        .data-table tbody tr:hover { background-color: #151515; }
        .data-table td { vertical-align: middle; }
        .thumb-img { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid #333; }
        
        .thumb-img.preview-large {
            width: 150px; 
            height: 60px; /* 寬高比 2.5:1 */
            object-fit: cover;
        }

        .featured-indicator, .status-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; }
        .featured-indicator.yes, .status-indicator.yes { background-color: var(--color-success); }
        .featured-indicator.no, .status-indicator.no { background-color: var(--color-text-dim); }
        
        .message-cell {
            max-width: 250px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }
        .message-cell:hover { white-space: normal; overflow: visible; }
        
        .answer-cell {
            max-width: 400px;
            font-size: 0.9em;
            color: var(--color-text-dim);
        }
        .icon-cell i {
            font-size: 1.5em;
            color: var(--color-text-light);
        }


        /* 數據分析卡片 */
        #statsGrid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;
        }
        .stat-card {
            background-color: #1A1A1A; padding: 20px; border-radius: 8px;
            border-left: 5px solid var(--color-primary); position: relative;
        }
        .stat-card h3 { font-size: 1.1em; color: var(--color-text-dim); margin: 0 0 10px 0; border: none; }
        .stat-card p { font-size: 2em; font-weight: bold; color: var(--color-text-light); }
        .stat-card .icon { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); font-size: 2.5em; color: var(--color-primary); opacity: 0.2; }

        /* 表單與輸入框 */
        input[type="text"], input[type="password"], input[type="email"], input[type="number"], input[type="url"], select, textarea {
            width: 100%; padding: 10px; background: #0A0A0A; border: 1px solid #333;
            color: white; border-radius: 3px; margin-bottom: 10px;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--color-primary); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        .form-group-inline {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }
        .form-group-inline input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        .form-group-inline label {
            margin: 0;
            font-weight: normal;
        }

        /* 彈窗 (Modal) */
        .modal {
            display: none; position: fixed; z-index: 3000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(3px);
        }
        .modal-content {
            background-color: #1A1A1A; margin: 5% auto; padding: 30px;
            border: 1px solid var(--color-secondary); border-radius: 8px;
            width: 90%; max-width: 600px; position: relative;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; border: none; }
        .close-btn { color: var(--color-text-dim); font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-btn:hover { color: white; }
        
        #productImagePreview, #carouselImagePreview { 
            max-width: 100%; height: auto; margin-top: 10px; border-radius: 5px; 
            border: 1px solid #333;
        }

        /* 系統設定佈局 */
        .settings-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        .settings-card {
            background-color: #1A1A1A;
            padding: 20px;
            border-radius: 8px;
        }
        .settings-card h3 { margin-top: 0; }

        /* 響應式 */
        @media (max-width: 1200px) {
            #statsGrid { grid-template-columns: 1fr 1fr; }
        }
        @media (max-width: 960px) {
            .settings-layout { grid-template-columns: 1fr; }
            .data-table th:nth-child(5), .data-table td:nth-child(5),
            .data-table th:nth-child(4), .data-table td:nth-child(4) {
                 display: none;
            }
        }
        @media (max-width: 768px) {
            .admin-layout { flex-direction: column; }
            .sidebar { width: 100%; border-right: none; border-bottom: 1px solid var(--color-secondary); }
            #statsGrid { grid-template-columns: 1fr; }
            .form-grid { grid-template-columns: 1fr; }
            .content-header { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>

    <div class="admin-layout">
        
        <aside class="sidebar">
            <h1><i class="fas fa-tachometer-alt"></i> 後台管理中心</h1>
            <nav>
                <ul>
                    <li class="nav-item"><a href="#" class="nav-link" data-tab="analytics"><i class="fas fa-chart-line"></i> 數據分析</a></li>
                    <li class="nav-item"><a href="#" class="nav-link" data-tab="orders"><i class="fas fa-receipt"></i> 訂單管理</a></li>
                    <li class="nav-item"><a href="#" class="nav-link" data-tab="products"><i class="fas fa-box-open"></i> 產品管理</a></li>
                    
                    <li class="nav-item"><a href="#" class="nav-link" data-tab="carousel"><i class="fas fa-images"></i> 首頁輪播管理</a></li>

                    <li class="nav-item"><a href="#" class="nav-link" data-tab="downloads"><i class="fas fa-download"></i> 下載管理</a></li>
                    <li class="nav-item"><a href="#" class="nav-link" data-tab="faqs"><i class="fas fa-question-circle"></i> 疑問管理 (FAQ)</a></li>
                    
                    <li class="nav-item"><a href="#" class="nav-link" data-tab="users"><i class="fas fa-users"></i> 使用者管理</a></li>
                    <li class="nav-item"><a href="#" class="nav-link" data-tab="settings"><i class="fas fa-cog"></i> 系統設定</a></li>
                </ul>
            </nav>
            <div class="logout-section">
                <ul>
                    <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> 登出並返回首頁</a></li>
                </ul>
            </div>
        </aside>

        <main class="main-content">
            
            <div id="analytics" class="tab-content active">
                <h2><i class="fas fa-chart-line"></i> 數據分析</h2>
                <div id="statsGrid">
                    <div class="stat-card">
                        <h3>總銷售額</h3>
                        <p id="totalRevenue">NT$ 0</p>
                        <i class="fas fa-dollar-sign icon"></i>
                    </div>
                    <div class="stat-card">
                        <h3>總訂單數</h3>
                        <p id="totalOrders">0</p>
                        <i class="fas fa-receipt icon"></i>
                    </div>
                    <div class="stat-card">
                        <h3>註冊會員</h3>
                        <p id="totalMembers">0</p>
                        <i class="fas fa-users icon"></i>
                    </div>
                    <div class="stat-card">
                        <h3>產品總數</h3>
                        <p id="totalProducts">0</p>
                        <i class="fas fa-box-open icon"></i>
                    </div>
                </div>
                <button class="btn btn-secondary" id="exportSalesButton"><i class="fas fa-file-export"></i> 匯出銷售數據 (模擬)</button>
            </div>

            <div id="orders" class="tab-content">
                <h2><i class="fas fa-receipt"></i> 訂單管理</h2>
                <div class="table-responsive">
                    <table id="orderTable" class="data-table">
                        <thead>
                            <tr>
                                <th>訂單編號</th>
                                <th>日期</th>
                                <th>客戶</th>
                                <th>品項</th>
                                <th>總金額</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="products" class="tab-content">
                <div class="content-header">
                    <h2><i class="fas fa-box-open"></i> 產品管理</h2>
                    <button class="btn btn-primary" id="addNewProductBtn"><i class="fas fa-plus"></i> 新增產品</button>
                </div>
                <div class="table-responsive">
                    <table id="productTable" class="data-table">
                        <thead>
                            <tr>
                                <th>圖片</th>
                                <th>ID</th>
                                <th>產品名稱</th>
                                <th>主分類</th>
                                <th>子分類</th>
                                <th>價格</th>
                                <th>庫存</th>
                                <th>精選</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="carousel" class="tab-content">
                <h2><i class="fas fa-images"></i> 首頁輪播管理 (Hero Slideshow)</h2>
                
                <div class="settings-card" style="margin-bottom: 30px;">
                    <h3><i class="fas fa-cog"></i> 輪播設定</h3>
                    <form id="carouselSettingsForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="carouselSpeed">切換速度 (毫秒, e.g., 5000 = 5秒)</label>
                                <input type="number" id="carouselSpeed" value="5000" min="1000" step="500" required>
                            </div>
                            <div class="form-group-inline" style="align-items: center; height: 100%; border: 1px solid #333; padding: 10px; border-radius: 3px;">
                                <input type="checkbox" id="carouselEnabled" style="margin-bottom: 0;">
                                <label for="carouselEnabled">啟用首頁輪播 (若取消，首頁將顯示預設靜態文字)</label>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary" style="margin-top: 15px;"><i class="fas fa-save"></i> 儲存設定</button>
                    </form>
                </div>

                <div class="content-header">
                    <h3><i class="fas fa-image"></i> 圖片列表</h3>
                    <button class="btn btn-primary" id="addNewCarouselBtn"><i class="fas fa-plus"></i> 新增輪播圖片</button>
                </div>
                <div class="table-responsive">
                    <table id="carouselTable" class="data-table">
                        <thead>
                            <tr>
                                <th>預覽 (建議 1920x800)</th>
                                <th>標題 (Title)</th>
                                <th>點擊連結 (URL)</th>
                                <th>顯示 (Visible)</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="downloads" class="tab-content">
                <div class="content-header">
                    <h2><i class="fas fa-download"></i> 下載中心管理</h2>
                    <button class="btn btn-primary" id="addNewDownloadBtn"><i class="fas fa-plus"></i> 新增下載項目</button>
                </div>
                <div class="table-responsive">
                    <table id="downloadTable" class="data-table">
                        <thead>
                            <tr>
                                <th>圖示</th>
                                <th>分類</th>
                                <th>標題</th>
                                <th>描述</th>
                                <th>可見</th>
                                <th>可下載</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="faqs" class="tab-content">
                <div class="content-header">
                    <h2><i class="fas fa-question-circle"></i> 常見疑問 (FAQ) 管理</h2>
                    <button class="btn btn-primary" id="addNewFaqBtn"><i class="fas fa-plus"></i> 新增 FAQ</button>
                </div>
                <div class="table-responsive">
                    <table id="faqTable" class="data-table">
                        <thead>
                            <tr>
                                <th>問題 (Question)</th>
                                <th>答案 (Answer) - (HTML 格式)</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>
            
            <div id="users" class="tab-content">
                <h2><i class="fas fa-users"></i> 使用者管理</h2>
                
                <h3><i class="fas fa-search"></i> 搜尋註冊會員</h3>
                <div class="search-bar content-header">
                    <input type="text" id="userSearchInput" placeholder="搜尋姓名或 Email..." style="margin-bottom: 0;">
                    <button class="btn btn-secondary" id="userSearchButton"><i class="fas fa-search"></i> 搜尋</button>
                </div>
                <div class="table-responsive">
                    <table id="userTable" class="data-table">
                        <thead>
                            <tr>
                                <th>會員 ID</th>
                                <th>姓名</th>
                                <th>Email</th>
                                <th>總消費</th>
                                <th>總訂單</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>

                <h3><i class="fas fa-file-signature"></i> 前台諮詢登記</h3>
                <div class="table-responsive">
                    <table id="registrationTable" class="data-table">
                        <thead>
                            <tr>
                                <th>登記日期</th>
                                <th>姓名</th>
                                <th>電話</th>
                                <th>Email</th>
                                <th>諮詢內容</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
                <button class="btn btn-danger" id="clearRegistrationsButton" style="margin-top: 15px;"><i class="fas fa-trash"></i> 清空所有諮詢 (模擬)</button>
            </div>

            <div id="settings" class="tab-content">
                <h2><i class="fas fa-cog"></i> 系統設定</h2>
                <div class="settings-layout">
                    
                    <div class="settings-card">
                        <h3><i class="fas fa-user-shield"></i> 管理者帳戶</h3>
                        <form id="adminProfileForm">
                            <div class="form-group">
                                <label for="adminName">管理者名稱</label>
                                <input type="text" id="adminName" value="Administrator">
                            </div>
                            <div class="form-group">
                                <label for="adminEmail">管理者 Email</label>
                                <input type="email" id="adminEmail" value="admin@test.com">
                            </div>
                            <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> 儲存資料</button>
                        </form>
                    </div>

                    <div class="settings-card">
                        <h3><i class="fas fa-key"></i> 變更管理者密碼</h3>
                        <form id="adminPasswordForm">
                            <div class="form-group">
                                <label for="adminOldPass">舊密碼</label>
                                <input type="password" id="adminOldPass">
                            </div>
                            <div class="form-group">
                                <label for="adminNewPass">新密碼</label>
                                <input type="password" id="adminNewPass">
                            </div>
                            <button type="submit" class="btn btn-warning"><i class="fas fa-sync-alt"></i> 變更密碼</button>
                        </form>
                    </div>

                    <div class="settings-card">
                        <h3><i class="fas fa-user-plus"></i> 新增管理者 (模擬)</h3>
                        <form id="secondAdminForm">
                            <div class="form-group">
                                <label for="adminNewUser">新管理者帳號</label>
                                <input type="text" id="adminNewUser" placeholder="e.g., admin2">
                            </div>
                            <div class="form-group">
                                <label for="adminNewUserPass">設定密碼</label>
                                <input type="password" id="adminNewUserPass">
                            </div>
                            <button type="submit" class="btn btn-secondary"><i class="fas fa-plus"></i> 創建帳戶</button>
                        </form>
                    </div>

                    <div class="settings-card">
                        <h3><i class="fas fa-database"></i> 數據庫 (模擬)</h3>
                        <p style="color: var(--color-text-dim); margin-bottom: 15px;">
                            所有資料 (產品、使用者、訂單) 目前皆使用您瀏覽器的 LocalStorage 儲存。
                        </p>
                        <button class="btn btn-danger" id="factoryResetButton"><i class="fas fa-exclamation-triangle"></i> 恢復原廠設定 (清除快取)</button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="productModalTitle">新增產品</h2>
                <span class="close-btn" id="closeProductModalBtn">&times;</span>
            </div>
            <form id="productForm">
                <input type="hidden" id="productId">
                <input type="hidden" id="productImageUrl"> <div class="form-group">
                    <label for="title">產品名稱</label>
                    <input type="text" id="title" required>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="productMainCategory">主分類 (Main Category)</label>
                        <select id="productMainCategory">
                            <option value="security">監視系統 (security)</option>
                            <option value="access">門禁系統 (access)</option>
                            <option value="network">網路通訊 (network)</option>
                            <option value="other">其他配件 (other)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="productSubCategory">子分類 (顯示文字)</label>
                        <input type="text" id="productSubCategory" placeholder="e.g., 有線監視器">
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label for="price">價格 (NT$)</label>
                        <input type="number" id="price" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="stock">庫存</label>
                        <input type="number" id="stock" min="0" value="0">
                    </div>
                </div>

                <div class="form-group">
                    <label for="description">產品描述</label>
                    <textarea id="description" rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label for="productImageFile">上傳圖片 (會轉為 Base64)</label>
                    <input type="file" id="productImageFile" accept="image/*">
                    <img id="productImagePreview" src="" alt="Image Preview" style="display:none;">
                </div>
                
                <div class="form-group-inline">
                    <input type="checkbox" id="isFeatured">
                    <label for="isFeatured">設為精選產品 (顯示於首頁)</label>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px; margin-top: 20px;"><i class="fas fa-save"></i> 儲存</button>
            </form>
        </div>
    </div>

    <div id="passwordModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h2 id="passwordModalTitle">重設密碼</h2>
                <span class="close-btn" id="closePasswordModalBtn">&times;</span>
            </div>
            <form id="individualPasswordForm">
                <input type="hidden" id="passwordUserId">
                <p>您正在為 <strong id="passwordUserName">...</strong> 重設密碼。</p>
                <div class="form-group">
                    <label for="newPassword">輸入新密碼</label>
                    <input type="password" id="newPassword" required>
                </div>
                <button type="submit" class="btn btn-warning" style="width: 100%;"><i class="fas fa-key"></i> 確認重設</button>
            </form>
        </div>
    </div>

    <div id="downloadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="downloadModalTitle">新增下載項目</h2>
                <span class="close-btn" id="closeDownloadModalBtn">&times;</span>
            </div>
            <form id="downloadForm">
                <input type="hidden" id="downloadId">
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="downloadCategory">分類</label>
                        <select id="downloadCategory">
                            <option value="program">程式 (program)</option>
                            <option value="document">文件 (document)</option>
                            <option value="image">圖檔 (image)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="downloadIcon">FontAwesome 圖示</label>
                        <input type="text" id="downloadIcon" value="fas fa-file-alt" placeholder="e.g., fas fa-file-pdf">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="downloadTitle">標題</label>
                    <input type="text" id="downloadTitle" required>
                </div>
                
                <div class="form-group">
                    <label for="downloadDescription">描述</label>
                    <input type="text" id="downloadDescription">
                </div>

                <div class="form-group">
                    <label for="downloadUrl">檔案連結 (URL)</label>
                    <input type="url" id="downloadUrl" placeholder="https://... 或 /files/file.zip">
                </div>

                <div class="form-group-inline">
                    <input type="checkbox" id="downloadIsVisible" checked>
                    <label for="downloadIsVisible">顯示於前台</label>
                </div>
                <div class="form-group-inline">
                    <input type="checkbox" id="downloadIsDownloadable" checked>
                    <label for="downloadIsDownloadable">允許下載 (若取消，則僅為連結)</label>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px; margin-top: 20px;"><i class="fas fa-save"></i> 儲存</button>
            </form>
        </div>
    </div>

    <div id="faqModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="faqModalTitle">新增 FAQ</h2>
                <span class="close-btn" id="closeFaqModalBtn">&times;</span>
            </div>
            <form id="faqForm">
                <input type="hidden" id="faqId">
                
                <div class="form-group">
                    <label for="faqQuestion">問題 (Question)</label>
                    <input type="text" id="faqQuestion" placeholder="e.g., Q: 請問..." required>
                </div>
                
                <div class="form-group">
                    <label for="faqAnswer">答案 (Answer) - (可使用 HTML)</label>
                    <textarea id="faqAnswer" rows="5" placeholder="e.g., <p>A: <strong>是的</strong>...</p>"></textarea>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px; margin-top: 20px;"><i class="fas fa-save"></i> 儲存</button>
            </form>
        </div>
    </div>


    <div id="carouselModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="carouselModalTitle">新增輪播圖片</h2>
                <span class="close-btn" id="closeCarouselModalBtn">&times;</span>
            </div>
            <form id="carouselForm">
                <input type="hidden" id="carouselId">
                <input type="hidden" id="carouselImageUrl"> <div class="form-group">
                    <label for="carouselTitle">標題 (顯示在圖片上)</label>
                    <input type="text" id="carouselTitle" placeholder="e.g., 最新優惠活動 (可留空)">
                </div>
                
                <div class="form-group">
                    <label for="carouselSubTitle">副標題 (顯示在標題下方)</label>
                    <input type="text" id="carouselSubTitle" placeholder="e.g., 全館 8 折起 (可留空)">
                </div>

                <div class="form-group">
                    <label for="carouselLink">點擊連結 (URL)</label>
                    <input type="url" id="carouselLink" placeholder="https://... 或 /shop.html (留空=無法點擊)">
                </div>

                <div class="form-group">
                    <label for="carouselImageFile">上傳圖片 (建議 1920x800 或相似比例)</label>
                    <input type="file" id="carouselImageFile" accept="image/*">
                    <img id="carouselImagePreview" src="" alt="Image Preview" style="display:none;">
                </div>

                
                <div class="form-group-inline">
                    <input type="checkbox" id="carouselIsVisible" checked>
                    <label for="carouselIsVisible">顯示此圖片 (若取消勾選，前台將不會顯示)</label>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px; margin-top: 20px;"><i class="fas fa-save"></i> 儲存</button>
            </form>
        </div>
    </div>


    <script>
        // ====================================
        // 核心資料與儲存 (使用 LocalStorage 模擬資料庫)
        // ====================================
        const INITIAL_PRODUCTS_DATA = [
            { id: "CAM001", title: "極光 Pro 4K 網路攝影機", mainCategory: "security", categoryText: "有線監視器", price: 8990, description: "4K 超高畫質, AI人形偵測", image: "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%231f1f1f'/><circle cx='50' cy='45' r='20' fill='%2300ffff'/><path d='M30 65H70L50 85Z' fill='%2300ffff'/><text x='50' y='95' font-size='10' fill='%23aaa' text-anchor='middle'>Camera 001</text></svg>", stock: 10, isFeatured: true },
            { id: "ACC002", title: "智能指紋辨識鎖", mainCategory: "access", categoryText: "門禁系統", price: 12500, description: "手機APP遠端開鎖", image: "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%231f1f1f'/><rect x='30' y='30' width='40' height='40' rx='5' fill='%230077b6'/><path d='M40 40H60V60H40Z' fill='white'/><text x='50' y='95' font-size='10' fill='%23aaa' text-anchor='middle'>Access 002</text></svg>", stock: 5, isFeatured: true },
            { id: "NET003", title: "企業級 Wi-Fi 6 路由器", mainCategory: "network", categoryText: "其他配件", price: 5200, description: "高速穩定, 適合商辦", image: "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%231f1f1f'/><rect x='20' y='40' width='60' height='20' rx='2' fill='%2300ffff'/><path d='M30 40V20M70 40V20' stroke='%2300ffff' stroke-width='3'/><text x='50' y='95' font-size='10' fill='%23aaa' text-anchor='middle'>Network 003</text></svg>", stock: 20, isFeatured: true },
        ];
        
        const MOCK_ORDERS_DATA = [
            { id: '#20251108A', date: '2025-11-08', user: '李先生 (M001)', items: '極光 Pro 4K x2', total: 17980 },
            { id: '#20251105C', date: '2025-11-05', user: '王小姐 (M002)', items: 'Wi-Fi 6 路由器 x1', total: 5200 },
        ];
        const MOCK_MEMBERS_DATA = [
            { id: "M001", name: "李先生", email: "member1@test.com", password: "N/A", totalSpent: 17980, totalOrders: 1 },
            { id: "M002", name: "王小姐", email: "member2@test.com", password: "N/A", totalSpent: 5200, totalOrders: 1 },
        ];
        
        const INITIAL_FAQS_DATA = [
            { id: 1, question: "Q: 請問服務範圍包含哪些地區？", answer: "<p><strong>A:</strong> 我們的總部設於新竹，主要服務範圍涵蓋**桃竹苗**地區。對於大型專案或企業級整合需求，我們也承接**全台灣**的服務。您可以隨時透過「關於我們」頁面的表單與我們聯繫，我們將有專人為您評估。</p>" },
            { id: 2, question: "Q: 你們提供現場估價嗎？是否需要收費？", answer: "<p><strong>A:</strong> 是的，我們提供現場勘查與估價服務。在桃竹苗地區，標準的現場勘查與初步報價是**免費**的。若需提供詳細的施工藍圖或跨區服務，可能會酌收車馬費或出圖費，這部分會由專案經理在與您接洽時先行告知。</p>" },
            { id: 3, question: "Q: 產品的保固期是多久？售後服務流程是？", answer: "<p><strong>A:</strong> <ul><li><strong>產品保固：</strong> 依據不同設備原廠規定，硬體設備（如攝影機、主機、門禁讀卡機）通常享有 1 至 3 年不等的原廠保固。</li><li><strong>施工保固：</strong> 由本公司施工安裝的部分，我們提供 1 年的施工品質保固。</li><li><strong>售後服務：</strong> 保固期間內，若非人為損壞，我們提供免費的檢修服務。若已過保，我們也提供付費維修與系統健檢，確保您的系統能長久穩定運作。</li></ul></p>" }
        ];
        const INITIAL_DOWNLOADS_DATA = [
            { id: 1, category: 'program', title: '遠端監控主程式 (Windows)', description: '適用於 Windows 10/11。', url: '#', icon: 'fab fa-windows', isVisible: true, isDownloadable: true },
            { id: 2, category: 'document', title: 'CAM001 產品說明書 (PDF)', description: '極光 Pro 4K 網路攝影機 (CAM001) 詳細規格與安裝指南。', url: '#', icon: 'fas fa-file-pdf', isVisible: true, isDownloadable: true },
            { id: 3, category: 'image', title: '公司 Logo (PNG)', description: '透明背景，高解析度。', url: '#', icon: 'fas fa-image', isVisible: false, isDownloadable: true },
            { id: 4, category: 'program', title: '手機APP (Android)', description: 'Android 版本 v3.1.2', url: '#', icon: 'fab fa-android', isVisible: true, isDownloadable: false }
        ];

        const INITIAL_CAROUSEL_SETTINGS = { speed: 5000, enabled: true };
        const INITIAL_CAROUSEL_IMAGES = [
            // 預設是空的，讓使用者自行新增
        ];

        let PRODUCTS = [];
        let ALL_USERS = [];
        let DOWNLOADS = []; 
        let FAQS = []; 
        let CAROUSEL_SETTINGS = {};
        let CAROUSEL_IMAGES = [];
        
        let currentModalMode = 'add';
        let currentDownloadModalMode = 'add'; 
        let currentFaqModalMode = 'add'; 
        let currentCarouselModalMode = 'add';


        // 載入與儲存資料 (Load & Save)
        function loadData() {
            try {
                // 產品
                const storedProducts = localStorage.getItem('adminProducts');
                PRODUCTS = storedProducts ? JSON.parse(storedProducts) : INITIAL_PRODUCTS_DATA;
                if (!storedProducts) saveProducts();

                // 下載
                const storedDownloads = localStorage.getItem('adminDownloads');
                DOWNLOADS = storedDownloads ? JSON.parse(storedDownloads) : INITIAL_DOWNLOADS_DATA;
                if (!storedDownloads) saveDownloads();
                
                // FAQ
                const storedFaqs = localStorage.getItem('adminFaqs');
                FAQS = storedFaqs ? JSON.parse(storedFaqs) : INITIAL_FAQS_DATA;
                if (!storedFaqs) saveFaqs();

                // 輪播設定
                const storedCarouselSettings = localStorage.getItem('adminCarouselSettings');
                CAROUSEL_SETTINGS = storedCarouselSettings ? JSON.parse(storedCarouselSettings) : INITIAL_CAROUSEL_SETTINGS;
                if (!storedCarouselSettings) saveCarouselSettings();
                
                // 輪播圖片
                const storedCarouselImages = localStorage.getItem('adminCarouselImages');
                CAROUSEL_IMAGES = storedCarouselImages ? JSON.parse(storedCarouselImages) : INITIAL_CAROUSEL_IMAGES;
                if (!storedCarouselImages) saveCarouselImages();

            } catch (e) {
                console.error("Error loading data:", e);
                PRODUCTS = INITIAL_PRODUCTS_DATA;
                DOWNLOADS = INITIAL_DOWNLOADS_DATA;
                FAQS = INITIAL_FAQS_DATA;
                CAROUSEL_SETTINGS = INITIAL_CAROUSEL_SETTINGS;
                CAROUSEL_IMAGES = INITIAL_CAROUSEL_IMAGES;
            }
        }
        
        function saveProducts() {
            try {
                localStorage.setItem('adminProducts', JSON.stringify(PRODUCTS));
            } catch (e) { console.error("Error saving product data:", e); }
        }
        
        function saveDownloads() {
            try {
                localStorage.setItem('adminDownloads', JSON.stringify(DOWNLOADS));
            } catch (e) { console.error("Error saving download data:", e); }
        }
        
        function saveFaqs() {
            try {
                localStorage.setItem('adminFaqs', JSON.stringify(FAQS));
            } catch (e) { console.error("Error saving FAQ data:", e); }
        }

        function saveCarouselSettings() {
            try {
                localStorage.setItem('adminCarouselSettings', JSON.stringify(CAROUSEL_SETTINGS));
            } catch (e) { console.error("Error saving carousel settings:", e); }
        }
        
        function saveCarouselImages() {
            try {
                localStorage.setItem('adminCarouselImages', JSON.stringify(CAROUSEL_IMAGES));
            } catch (e) { console.error("Error saving carousel images:", e); }
        }


        // ====================================
        // 諮詢資料讀取與管理
        // ====================================
        function loadRegistrations() {
            let registrations = [];
            try {
                const data = localStorage.getItem('USER_REGISTRATIONS');
                registrations = data ? JSON.parse(data) : [];
            } catch (e) { console.error("無法讀取諮詢資料:", e); }
            return registrations;
        }

        function clearRegistrations() {
            if (confirm("確定要清空所有 '前台諮詢登記' 嗎？\n此操作將刪除 USER_REGISTRATIONS 中的所有資料且無法復原。")) {
                try {
                    localStorage.removeItem('USER_REGISTRATIONS');
                    renderRegistrationTable(); // 重新渲染空表格
                    alert('諮詢資料已清空！');
                } catch (e) { alert('清空失敗，請檢查主控台。'); }
            }
        }

        function renderRegistrationTable() {
            const tableBody = document.querySelector('#registrationTable tbody');
            if (!tableBody) return;
            tableBody.innerHTML = '';
            const registrations = loadRegistrations();

            if (registrations.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: var(--color-text-dim);">尚無諮詢資料</td></tr>';
                return;
            }

            registrations.forEach(reg => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${reg.date}</td>
                    <td>${reg.name}</td>
                    <td>${reg.phone}</td>
                    <td>${reg.email}</td>
                    <td class="message-cell">${reg.message}</td>
                `;
            });
        }
        
        function prepareUserData() {
            // 讀取 LocalStorage 中的 'userManagementData' (由 index/register 頁面產生)
            let storedUsers = [];
            try {
                const data = localStorage.getItem('userManagementData');
                storedUsers = data ? JSON.parse(data) : [];
            } catch (e) { console.error("無法讀取使用者資料:", e); }
            
            // 合併 MOCK_MEMBERS_DATA 和 storedUsers
            // 這裡使用 Email 作為合併的 Key
            const combinedUserMap = new Map();
            
            // 1. 先加入 MOCK (模擬的舊會員)
            MOCK_MEMBERS_DATA.forEach(user => {
                combinedUserMap.set(user.email, {
                    ...user,
                    password: user.password || "N/A", // 確保有密碼欄位
                    totalSpent: user.totalSpent || 0,
                    totalOrders: user.totalOrders || 0
                });
            });

            // 2. 加入 (或覆蓋) LocalStorage 的註冊會員
            storedUsers.forEach(user => {
                const existingUser = combinedUserMap.get(user.email);
                if (existingUser) {
                    // 合併資料 (例如，保留舊會員的消費紀錄，但更新姓名)
                    combinedUserMap.set(user.email, {
                        ...existingUser,
                        id: user.id || existingUser.id,
                        name: user.name || existingUser.name,
                        password: user.password || existingUser.password // 更新密碼
                    });
                } else {
                    // 全新會員
                    combinedUserMap.set(user.email, {
                        ...user,
                        id: user.id || `M${Date.now()}`,
                        totalSpent: 0,
                        totalOrders: 0,
                        password: user.password || "N/A"
                    });
                }
            });
            
            ALL_USERS = Array.from(combinedUserMap.values());
        }
        
        // 通用化圖片預覽
        function setupImagePreview(inputId, previewId, hiddenInputId) {
            const fileInput = document.getElementById(inputId);
            const preview = document.getElementById(previewId);
            const hiddenInput = document.getElementById(hiddenInputId);
            
            if (!fileInput || !preview || !hiddenInput) return;

            fileInput.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (!file) {
                    hiddenInput.value = ''; // 清除
                    preview.style.display = 'none';
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64String = e.target.result;
                    preview.src = base64String;
                    preview.style.display = 'block';
                    // 將 Base64 存入隱藏欄位，準備提交
                    hiddenInput.value = base64String;
                };
                reader.readAsDataURL(file);
            });
        }


        // ====================================
        // 1. 商品管理 (CRUD) 邏輯 
        // ====================================
        function renderProductTable() {
            const tableBody = document.querySelector('#productTable tbody');
            if (!tableBody) return;
            tableBody.innerHTML = '';
            
            PRODUCTS.forEach(product => {
                const isFeatured = product.isFeatured ? 
                    '<span class="featured-indicator yes" title="是"></span> 是' : 
                    '<span class="featured-indicator no" title="否"></span> 否';
                
                const imageSrc = product.image ? (product.image.startsWith('data:image') ? product.image : product.image) : ''; 

                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td><img src="${imageSrc}" alt="${product.title}" class="thumb-img" onerror="this.style.display='none'"></td>
                    <td>${product.id}</td>
                    <td>${product.title}</td>
                    <td>${product.mainCategory}</td>
                    <td>${product.categoryText}</td>
                    <td>NT$ ${product.price.toLocaleString()}</td>
                    <td>${product.stock}</td>
                    <td>${isFeatured}</td>
                    <td>
                        <button class="btn btn-edit" onclick="openProductModal('edit', '${product.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-delete" onclick="deleteProduct('${product.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
            });
        }

        function openProductModal(mode, id = null) {
            const modal = document.getElementById('productModal');
            const form = document.getElementById('productForm');
            const title = document.getElementById('productModalTitle');
            const preview = document.getElementById('productImagePreview');
            if (!modal || !form || !title) return;
            
            form.reset();
            currentModalMode = mode;
            title.textContent = mode === 'add' ? '新增產品' : '編輯產品';
            preview.style.display = 'none';
            preview.src = '';
            document.getElementById('productImageUrl').value = ''; // 清空隱藏 image URL

            if (mode === 'edit' && id) {
                const product = PRODUCTS.find(p => p.id === id);
                if (product) {
                    document.getElementById('productId').value = product.id;
                    document.getElementById('title').value = product.title;
                    document.getElementById('productMainCategory').value = product.mainCategory || 'other';
                    document.getElementById('productSubCategory').value = product.categoryText || '';
                    document.getElementById('price').value = product.price;
                    document.getElementById('stock').value = product.stock;
                    document.getElementById('description').value = product.description;
                    document.getElementById('isFeatured').checked = product.isFeatured;
                    
                    if (product.image) {
                        document.getElementById('productImageUrl').value = product.image; // 儲存舊的 Base64
                        preview.src = product.image;
                        preview.style.display = 'block';
                    }
                }
            } else {
                document.getElementById('productId').value = '';
            }
            modal.style.display = 'block';
        }

        function closeProductModal() {
            const modal = document.getElementById('productModal');
            if (modal) modal.style.display = 'none';
            document.getElementById('productImagePreview').src = '';
            document.getElementById('productForm').reset();
            document.getElementById('productImageFile').value = ''; // 確保檔案輸入也被重置
        }

        function deleteProduct(id) {
            if (confirm(`確定要刪除 ID: ${id} 的產品嗎？`)) {
                PRODUCTS = PRODUCTS.filter(p => p.id !== id);
                saveProducts();
                renderProductTable();
                renderAnalytics(); // 更新數據
                alert('產品已刪除！');
            }
        }

        // ====================================
        // 2. 數據分析 (Analytics) 邏輯
        // ====================================
        function calculateAnalytics() {
            const totalRevenue = MOCK_ORDERS_DATA.reduce((sum, order) => sum + order.total, 0);
            const totalOrders = MOCK_ORDERS_DATA.length;
            const totalMembers = ALL_USERS.length;
            const totalProducts = PRODUCTS.length;
            return { totalRevenue, totalOrders, totalMembers, totalProducts };
        }

        function renderAnalytics() {
            const stats = calculateAnalytics();
            if (document.getElementById('totalRevenue')) document.getElementById('totalRevenue').textContent = `NT$ ${stats.totalRevenue.toLocaleString()}`;
            if (document.getElementById('totalOrders')) document.getElementById('totalOrders').textContent = stats.totalOrders;
            if (document.getElementById('totalMembers')) document.getElementById('totalMembers').textContent = stats.totalMembers;
            if (document.getElementById('totalProducts')) document.getElementById('totalProducts').textContent = stats.totalProducts;
        }

        function exportSalesData() {
            alert(" (模擬) 正在匯出銷售數據...\n（此功能需後端支援）");
        }

        // ====================================
        // 3. 訂單管理 (Order Management)
        // ====================================
        function renderOrderTable() {
            const tableBody = document.querySelector('#orderTable tbody');
            if (!tableBody) return;
            tableBody.innerHTML = '';
            
            MOCK_ORDERS_DATA.forEach(order => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${order.id}</td>
                    <td>${order.date}</td>
                    <td>${order.user}</td>
                    <td>${order.items}</td>
                    <td>NT$ ${order.total.toLocaleString()}</td>
                `;
            });
        }

        // ====================================
        // 4. 使用者管理 (User Management)
        // ====================================
        function renderUserTable(usersToRender) {
            const tableBody = document.querySelector('#userTable tbody');
            if (!tableBody) return;
            tableBody.innerHTML = '';

            if (!usersToRender || usersToRender.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; color: var(--color-text-dim);">找不到符合的會員</td></tr>';
                return;
            }

            usersToRender.forEach(user => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td>NT$ ${user.totalSpent.toLocaleString()}</td>
                    <td>${user.totalOrders}</td>
                    <td>
                        <button class="btn btn-warning" onclick="openPasswordModal('${user.id}', '${user.name}')"><i class="fas fa-key"></i> 重設密碼</button>
                    </td>
                `;
            });
        }

        function searchUsers() {
            const query = document.getElementById('userSearchInput').value.toLowerCase();
            if (!query) {
                renderUserTable(ALL_USERS); // 顯示全部
                return;
            }
            const filteredUsers = ALL_USERS.filter(user => 
                user.name.toLowerCase().includes(query) || 
                user.email.toLowerCase().includes(query)
            );
            renderUserTable(filteredUsers);
        }

        function openPasswordModal(userId, userName) {
            const modal = document.getElementById('passwordModal');
            if (!modal) return;
            document.getElementById('passwordUserId').value = userId;
            document.getElementById('passwordUserName').textContent = userName;
            modal.style.display = 'block';
        }

        function closePasswordModal() {
            const modal = document.getElementById('passwordModal');
            if (!modal) return;
            modal.style.display = 'none';
            document.getElementById('individualPasswordForm').reset();
        }
        
        
        // ====================================
        // 8. 下載管理 (Download Management)
        // ====================================
        function renderDownloadTable() {
            const tableBody = document.querySelector('#downloadTable tbody');
            if (!tableBody) return;
            tableBody.innerHTML = '';
            
            DOWNLOADS.forEach(item => {
                const isVisible = item.isVisible ? 
                    '<span class="status-indicator yes" title="是"></span> 是' : 
                    '<span class="status-indicator no" title="否"></span> 否';
                const isDownloadable = item.isDownloadable ? 
                    '<span class="status-indicator yes" title="是"></span> 是' : 
                    '<span class="status-indicator no" title="否"></span> 否';
                
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td class="icon-cell"><i class="${item.icon || 'fas fa-file-alt'}"></i></td>
                    <td>${item.category}</td>
                    <td>${item.title}</td>
                    <td>${item.description}</td>
                    <td>${isVisible}</td>
                    <td>${isDownloadable}</td>
                    <td>
                        <button class="btn btn-edit" onclick="openDownloadModal('edit', ${item.id})"><i class="fas fa-edit"></i> 編輯</button>
                        <button class="btn btn-delete" onclick="deleteDownload(${item.id})"><i class="fas fa-trash"></i> 刪除</button>
                    </td>
                `;
            });
        }

        function openDownloadModal(mode, id = null) {
            const modal = document.getElementById('downloadModal');
            const form = document.getElementById('downloadForm');
            const title = document.getElementById('downloadModalTitle');
            if (!modal || !form || !title) return;
            
            form.reset();
            currentDownloadModalMode = mode;
            title.textContent = mode === 'add' ? '新增下載項目' : '編輯下載項目';

            if (mode === 'edit' && id) {
                const item = DOWNLOADS.find(i => i.id == id);
                if (item) {
                    document.getElementById('downloadId').value = item.id;
                    document.getElementById('downloadCategory').value = item.category;
                    document.getElementById('downloadIcon').value = item.icon;
                    document.getElementById('downloadTitle').value = item.title;
                    document.getElementById('downloadDescription').value = item.description;
                    document.getElementById('downloadUrl').value = item.url;
                    document.getElementById('downloadIsVisible').checked = !!item.isVisible;
                    document.getElementById('downloadIsDownloadable').checked = !!item.isDownloadable;
                }
            } else {
                document.getElementById('downloadId').value = '';
                document.getElementById('downloadIsVisible').checked = true;
                document.getElementById('downloadIsDownloadable').checked = true;
            }
            modal.style.display = 'block';
        }

        function closeDownloadModal() {
            const modal = document.getElementById('downloadModal');
            if (modal) modal.style.display = 'none';
        }

        function deleteDownload(id) {
            if (confirm(`確定要刪除 ID: ${id} 的下載項目嗎？`)) {
                DOWNLOADS = DOWNLOADS.filter(i => i.id != id);
                saveDownloads();
                renderDownloadTable();
                alert('下載項目已刪除！');
            }
        }

        // ====================================
        // 9. FAQ 管理 (FAQ Management)
        // ====================================
        function renderFaqTable() {
            const tableBody = document.querySelector('#faqTable tbody');
            if (!tableBody) return;
            tableBody.innerHTML = '';
            
            FAQS.forEach(item => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td class="message-cell">${item.question}</td>
                    <td class="answer-cell">${item.answer}</td>
                    <td>
                        <button class="btn btn-edit" onclick="openFaqModal('edit', ${item.id})"><i class="fas fa-edit"></i> 編輯</button>
                        <button class="btn btn-delete" onclick="deleteFaq(${item.id})"><i class="fas fa-trash"></i> 刪除</button>
                    </td>
                `;
            });
        }

        function openFaqModal(mode, id = null) {
            const modal = document.getElementById('faqModal');
            const form = document.getElementById('faqForm');
            const title = document.getElementById('faqModalTitle');
            if (!modal || !form || !title) return;
            
            form.reset();
            currentFaqModalMode = mode;
            title.textContent = mode === 'add' ? '新增 FAQ' : '編輯 FAQ';

            if (mode === 'edit' && id) {
                const item = FAQS.find(i => i.id == id);
                if (item) {
                    document.getElementById('faqId').value = item.id;
                    document.getElementById('faqQuestion').value = item.question;
                    document.getElementById('faqAnswer').value = item.answer;
                }
            } else {
                document.getElementById('faqId').value = '';
            }
            modal.style.display = 'block';
        }

        function closeFaqModal() {
            const modal = document.getElementById('faqModal');
            if (modal) modal.style.display = 'none';
        }

        function deleteFaq(id) {
            if (confirm(`確定要刪除 ID: ${id} 的 FAQ 嗎？`)) {
                FAQS = FAQS.filter(i => i.id != id);
                saveFaqs();
                renderFaqTable();
                alert('FAQ 已刪除！');
            }
        }

        // ====================================
        // 10. 輪播管理 (Carousel Management) - (此區為完整)
        // ====================================
        
        function renderCarouselSettings() {
            if (document.getElementById('carouselSpeed')) {
                document.getElementById('carouselSpeed').value = CAROUSEL_SETTINGS.speed || 5000;
                document.getElementById('carouselEnabled').checked = !!CAROUSEL_SETTINGS.enabled;
            }
        }

        function renderCarouselTable() {
            const tableBody = document.querySelector('#carouselTable tbody');
            if (!tableBody) return;
            tableBody.innerHTML = '';
            
            if (CAROUSEL_IMAGES.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: var(--color-text-dim);">尚無輪播圖片，請點擊「新增輪播圖片」。</td></tr>';
                return;
            }

            CAROUSEL_IMAGES.forEach(item => {
                const isVisible = item.isVisible ? 
                    '<span class="status-indicator yes" title="是"></span> 是' : 
                    '<span class="status-indicator no" title="否"></span> 否';
                
                const imageSrc = item.image ? (item.image.startsWith('data:image') ? item.image : item.image) : ''; 

                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td><img src="${imageSrc}" alt="${item.title}" class="thumb-img preview-large" onerror="this.style.display='none'"></td>
                    <td>${item.title || 'N/A'}</td>
                    <td>${item.link ? `<a href="${item.link}" target="_blank">${item.link}</a>` : 'N/A'}</td>
                    <td>${isVisible}</td>
                    <td>
                        <button class="btn btn-edit" onclick="openCarouselModal('edit', '${item.id}')"><i class="fas fa-edit"></i> 編輯</button>
                        <button class="btn btn-delete" onclick="deleteCarouselItem('${item.id}')"><i class="fas fa-trash"></i> 刪除</button>
                    </td>
                `;
            });
        }

        function openCarouselModal(mode, id = null) {
            const modal = document.getElementById('carouselModal');
            const form = document.getElementById('carouselForm');
            const title = document.getElementById('carouselModalTitle');
            const preview = document.getElementById('carouselImagePreview');
            if (!modal || !form || !title) return;
            
            form.reset();
            currentCarouselModalMode = mode;
            title.textContent = mode === 'add' ? '新增輪播圖片' : '編輯輪播圖片';
            preview.style.display = 'none';
            preview.src = '';
            document.getElementById('carouselImageUrl').value = ''; // 清空隱藏 image URL

            if (mode === 'edit' && id) {
                const item = CAROUSEL_IMAGES.find(i => i.id == id);
                if (item) {
                    document.getElementById('carouselId').value = item.id;
                    document.getElementById('carouselTitle').value = item.title || '';
                    document.getElementById('carouselSubTitle').value = item.subtitle || '';
                    document.getElementById('carouselLink').value = item.link || '';
                    document.getElementById('carouselIsVisible').checked = !!item.isVisible;
                    
                    if (item.image) {
                        document.getElementById('carouselImageUrl').value = item.image; // 儲存舊的 Base64
                        preview.src = item.image;
                        preview.style.display = 'block';
                    }
                }
            } else {
                document.getElementById('carouselId').value = '';
                document.getElementById('carouselIsVisible').checked = true; // 新增時預設勾選
            }
            modal.style.display = 'block';
        }

        function closeCarouselModal() {
            const modal = document.getElementById('carouselModal');
            if (modal) modal.style.display = 'none';
            document.getElementById('carouselImagePreview').src = '';
            document.getElementById('carouselForm').reset();
            document.getElementById('carouselImageFile').value = ''; // 確保檔案輸入也被重置
        }

        function deleteCarouselItem(id) {
            if (confirm(`確定要刪除 ID: ${id} 的輪播圖片嗎？`)) {
                CAROUSEL_IMAGES = CAROUSEL_IMAGES.filter(i => i.id != id);
                saveCarouselImages();
                renderCarouselTable();
                alert('輪播圖片已刪除！');
            }
        }


        // ====================================
        // 5. 登出與總控 
        // ====================================
        function handleLogout() {
            if (confirm("確定要登出嗎？")) {
                sessionStorage.removeItem('isLoggedIn');
                window.location.href = 'index.html';
            }
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });

            const activeTab = document.getElementById(tabId);
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            const navLink = document.querySelector(`.nav-link[data-tab="${tabId}"]`);
            if (navLink) {
                navLink.classList.add('active');
            }

            // 在切換時才載入數據
            try {
                if (tabId === 'products') {
                    renderProductTable();
                } else if (tabId === 'analytics') {
                    renderAnalytics();
                } else if (tabId === 'orders') {
                    renderOrderTable();
                } else if (tabId === 'users') { 
                    prepareUserData(); // 重新整理會員資料
                    renderUserTable(ALL_USERS); 
                    renderRegistrationTable();
                } else if (tabId === 'downloads') { 
                    renderDownloadTable();
                } else if (tabId === 'faqs') { 
                    renderFaqTable();
                } else if (tabId === 'carousel') { 
                    renderCarouselSettings();
                    renderCarouselTable();
                }
            } catch (e) {
                console.error(`載入 ${tabId} 分頁時出錯:`, e);
                alert(`載入 ${tabId} 分頁時出錯，請檢查主控台 (F12)`);
            }
        }

        // ====================================
        // 7. 程式進入點 (Entry Point)
        // ====================================

        document.addEventListener('DOMContentLoaded', function() {
            
            // 登入驗證
            const isLoggedIn = sessionStorage.getItem('isLoggedIn');
            if (isLoggedIn !== 'admin') {
                alert("您沒有權限訪問此頁面，請先登入。");
                window.location.href = 'index.html';
                return; // 停止執行
            }
            
            try {
                loadData(); 
                prepareUserData(); 
            } catch (e) {
                console.error("啟動時載入基礎資料失敗:", e);
                alert("載入基礎資料時發生錯誤，功能可能不完整。");
            }


            // --- 綁定所有事件監聽器 ---

            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    switchTab(this.getAttribute('data-tab'));
                });
            });
            
            if (document.getElementById('logoutBtn')) document.getElementById('logoutBtn').addEventListener('click', (e) => { e.preventDefault(); handleLogout(); });
            if (document.getElementById('exportSalesButton')) document.getElementById('exportSalesButton').addEventListener('click', exportSalesData);
            if (document.getElementById('userSearchButton')) document.getElementById('userSearchButton').addEventListener('click', searchUsers);
            if (document.getElementById('clearRegistrationsButton')) document.getElementById('clearRegistrationsButton').addEventListener('click', clearRegistrations);
            
            // 綁定產品 (Product)
            if (document.getElementById('addNewProductBtn')) document.getElementById('addNewProductBtn').addEventListener('click', () => openProductModal('add'));
            if (document.getElementById('closeProductModalBtn')) document.getElementById('closeProductModalBtn').addEventListener('click', closeProductModal);
            setupImagePreview('productImageFile', 'productImagePreview', 'productImageUrl');
            
            // 綁定密碼 (Password)
            if (document.getElementById('closePasswordModalBtn')) document.getElementById('closePasswordModalBtn').addEventListener('click', closePasswordModal);


            // 產品表單提交
            const productForm = document.getElementById('productForm');
            if (productForm) {
                productForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const form = e.target;
                    const id = form.productId.value;
                    const title = form.title.value;
                    const mainCategory = document.getElementById('productMainCategory').value;
                    const categoryText = document.getElementById('productSubCategory').value;
                    const price = parseInt(form.price.value, 10);
                    const stock = parseInt(form.stock.value, 10);
                    const description = form.description.value;
                    const imageBase64 = document.getElementById('productImageUrl').value; // 已包含新或舊的 Base64
                    const isFeatured = form.isFeatured.checked;

                    const productData = {
                        title,
                        mainCategory,
                        categoryText,
                        category: mainCategory, // 保持舊欄位同步
                        price,
                        description,
                        stock,
                        isFeatured,
                        image: imageBase64 || '' // 使用儲存的 Base64 或空字串
                    };

                    if (currentModalMode === 'add') {
                        productData.id = 'PROD' + Date.now(); // 使用 Timestamp 確保唯一
                        PRODUCTS.push(productData);
                        alert('商品新增成功！');
                    }
                    else if (currentModalMode === 'edit') {
                        const index = PRODUCTS.findIndex(p => p.id === id);
                        if (index !== -1) {
                            PRODUCTS[index] = { ...PRODUCTS[index], ...productData, id: id }; // 保持 ID 不變
                            alert('商品編輯成功！');
                        }
                    }
                    saveProducts();
                    renderProductTable();
                    renderAnalytics(); // 更新數據
                    closeProductModal();
                });
            }
            
            // 密碼表單提交
            const indPasswordForm = document.getElementById('individualPasswordForm');
            if (indPasswordForm) {
                indPasswordForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const userId = document.getElementById('passwordUserId').value;
                    const newPass = document.getElementById('newPassword').value;
                    alert(`(模擬) 已將 ID: ${userId} 的密碼重設為 ${newPass}\n(此功能需後端支援)`);
                    closePasswordModal();
                });
            }
            
            // 管理者資料表單
            const adminProfileForm = document.getElementById('adminProfileForm');
            if (adminProfileForm) {
                adminProfileForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    alert('(模擬) 管理者資料已儲存！');
                });
            }
            
            // 管理者密碼表單
            const adminPasswordForm = document.getElementById('adminPasswordForm');
            if (adminPasswordForm) {
                adminPasswordForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    alert('(模擬) 管理者密碼已變更！');
                });
            }

            if (document.getElementById('secondAdminForm')) document.getElementById('secondAdminForm').addEventListener('submit', (e) => { e.preventDefault(); alert('(模擬) 已創建第二管理者帳戶！'); });
            
            if (document.getElementById('factoryResetButton')) document.getElementById('factoryResetButton').addEventListener('click', () => {
                if (confirm("【警告】\n您確定要清除所有 LocalStorage 快取嗎？\n所有產品、FAQ、下載等資料將恢復為預設值！")) {
                    localStorage.removeItem('adminProducts');
                    localStorage.removeItem('adminDownloads');
                    localStorage.removeItem('adminFaqs');
                    localStorage.removeItem('adminCarouselSettings');
                    localStorage.removeItem('adminCarouselImages');
                    localStorage.removeItem('userManagementData');
                    alert('快取已清除，請重新整理頁面。');
                    window.location.reload();
                }
            });


            // 綁定下載管理 (Download)
            if (document.getElementById('addNewDownloadBtn')) {
                document.getElementById('addNewDownloadBtn').addEventListener('click', () => openDownloadModal('add'));
            }
            if (document.getElementById('closeDownloadModalBtn')) {
                document.getElementById('closeDownloadModalBtn').addEventListener('click', closeDownloadModal);
            }
            const downloadForm = document.getElementById('downloadForm');
            if (downloadForm) {
                downloadForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const id = document.getElementById('downloadId').value;
                    const itemData = {
                        category: document.getElementById('downloadCategory').value,
                        icon: document.getElementById('downloadIcon').value,
                        title: document.getElementById('downloadTitle').value,
                        description: document.getElementById('downloadDescription').value,
                        url: document.getElementById('downloadUrl').value,
                        isVisible: document.getElementById('downloadIsVisible').checked,
                        isDownloadable: document.getElementById('downloadIsDownloadable').checked,
                    };

                    if (currentDownloadModalMode === 'add') {
                        itemData.id = Date.now(); // Simple ID
                        DOWNLOADS.push(itemData);
                        alert('下載項目新增成功！');
                    } else {
                        const index = DOWNLOADS.findIndex(i => i.id == id);
                        if (index !== -1) {
                            DOWNLOADS[index] = { ...itemData, id: parseInt(id) };
                            alert('下載項目編輯成功！');
                        }
                    }
                    saveDownloads();
                    renderDownloadTable();
                    closeDownloadModal();
                });
            }


            // 綁定 FAQ 管理
            if (document.getElementById('addNewFaqBtn')) {
                document.getElementById('addNewFaqBtn').addEventListener('click', () => openFaqModal('add'));
            }
            if (document.getElementById('closeFaqModalBtn')) {
                document.getElementById('closeFaqModalBtn').addEventListener('click', closeFaqModal);
            }
            const faqForm = document.getElementById('faqForm');
            if (faqForm) {
                faqForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const id = document.getElementById('faqId').value;
                    const itemData = {
                        question: document.getElementById('faqQuestion').value,
                        answer: document.getElementById('faqAnswer').value,
                    };

                    if (currentFaqModalMode === 'add') {
                        itemData.id = Date.now(); // Simple ID
                        FAQS.push(itemData);
                        alert('FAQ 新增成功！');
                    } else {
                        const index = FAQS.findIndex(i => i.id == id);
                        if (index !== -1) {

                            FAQS[index] = { ...itemData, id: parseInt(id) };
                            alert('FAQ 編輯成功！');
                        }
                    }
                    saveFaqs();
                    renderFaqTable();
                    closeFaqModal();
                });
            }

            // 綁定輪播管理 (Carousel)
            if (document.getElementById('addNewCarouselBtn')) {
                document.getElementById('addNewCarouselBtn').addEventListener('click', () => openCarouselModal('add'));
            }
            if (document.getElementById('closeCarouselModalBtn')) {
                document.getElementById('closeCarouselModalBtn').addEventListener('click', closeCarouselModal);
            }
            setupImagePreview('carouselImageFile', 'carouselImagePreview', 'carouselImageUrl');
            
            // 輪播設定表單提交
            const carouselSettingsForm = document.getElementById('carouselSettingsForm');
            if (carouselSettingsForm) {
                carouselSettingsForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    CAROUSEL_SETTINGS.speed = parseInt(document.getElementById('carouselSpeed').value, 10) || 5000;
                    CAROUSEL_SETTINGS.enabled = document.getElementById('carouselEnabled').checked;
                    saveCarouselSettings();
                    alert('輪播設定已儲存！');
                });
            }

            // 輪播圖片表單提交
            const carouselForm = document.getElementById('carouselForm');
            if (carouselForm) {
                carouselForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const id = document.getElementById('carouselId').value;
                    const imageBase64 = document.getElementById('carouselImageUrl').value; // 已包含新或舊的 Base64

                    // 檢查是否上傳了圖片 (或保留了舊圖片)
                    if (!imageBase64) {
                        alert('請上傳一張圖片！');
                        return;
                    }

                    const itemData = {
                        title: document.getElementById('carouselTitle').value,
                        subtitle: document.getElementById('carouselSubTitle').value,
                        link: document.getElementById('carouselLink').value || '',
                        isVisible: document.getElementById('carouselIsVisible').checked,
                        image: imageBase64
                    };

                    if (currentCarouselModalMode === 'add') {
                        itemData.id = 'IMG' + Date.now(); // 使用 Timestamp 確保唯一
                        CAROUSEL_IMAGES.push(itemData);
                        alert('輪播圖片新增成功！');
                    } else {
                        const index = CAROUSEL_IMAGES.findIndex(i => i.id == id);
                        if (index !== -1) {
                            CAROUSEL_IMAGES[index] = { ...CAROUSEL_IMAGES[index], ...itemData, id: id }; // 保持 ID 不變
                            alert('輪播圖片編輯成功！');
                        }
                    }
                    saveCarouselImages();
                    renderCarouselTable();
                    closeCarouselModal();
                });
            }


            // --- 預設載入 ---
            switchTab('analytics');
        });

    </script>

</body>
</html>