<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¶²ç«™å¾Œå°ç®¡ç†ç³»çµ± | æœªä¾†ç§‘æŠ€</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        :root {
            --color-dark-bg: #0A0A0A;
            --color-primary: #00FFFF;
            --color-secondary: #0077B6;
            --color-text-light: #F0F0F0;
            --color-text-dim: #AAAAAA;
            --color-danger: #FF6B6B;
            --color-success: #4CAF50;
            --color-warning: #FFC107;
            --sidebar-width: 250px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: var(--color-dark-bg); color: var(--color-text-light); line-height: 1.6; }
        a { color: var(--color-primary); text-decoration: none; }
        h2 { color: var(--color-primary); margin-bottom: 20px; border-bottom: 2px solid var(--color-secondary); padding-bottom: 10px; }
        h3 { color: var(--color-text-light); margin-top: 25px; margin-bottom: 15px; border-bottom: 1px dashed #333; padding-bottom: 5px;}

        /* ä¸»è¦ä½ˆå±€ */
        .admin-layout { display: flex; min-height: 100vh; }

        /* å´é‚Šæ¬„ */
        .sidebar {
            width: var(--sidebar-width); background-color: #1A1A1A; padding: 20px;
            flex-shrink: 0; border-right: 1px solid var(--color-secondary);
            display: flex; flex-direction: column;
        }
        .sidebar h1 { color: var(--color-text-light); font-size: 1.5em; text-align: center; margin-bottom: 30px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .sidebar nav { flex-grow: 1; }
        .sidebar nav ul { list-style: none; }
        .sidebar nav ul li { margin-bottom: 5px; }
        .sidebar nav ul li a {
            display: block; padding: 10px 15px; color: var(--color-text-dim); font-weight: bold;
            border-radius: 5px; transition: background-color 0.2s, color 0.2s;
        }
        .sidebar nav ul li a i { margin-right: 10px; width: 20px; text-align: center; }
        .sidebar nav ul li a:hover { background-color: #2A2A2A; color: var(--color-text-light); }
        .sidebar nav ul li a.active { background-color: var(--color-secondary); color: white; }
        /* ç™»å‡ºæŒ‰éˆ• */
        .logout-section a {
            background-color: var(--color-danger); color: white; text-align: center;
        }
        .logout-section a:hover { background-color: #ff8b8b; }

        /* ä¸»è¦å…§å®¹å€ */
        .main-content { flex-grow: 1; padding: 30px; overflow-x: hidden; }
        .tab-content { display: none; animation: fadeIn 0.5s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* é ‚éƒ¨æ“ä½œæ¬„ */
        .content-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;}
        .search-bar { display: flex; gap: 10px; }

        /* æŒ‰éˆ• */
        .btn {
            padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer;
            font-weight: bold; transition: all 0.2s;
        }
        .btn-primary { background-color: var(--color-success); color: white; }
        .btn-secondary { background-color: var(--color-secondary); color: white; }
        .btn-danger { background-color: var(--color-danger); color: white; }
        .btn-warning { background-color: var(--color-warning); color: black; }
        .btn:hover { opacity: 0.8; }
        .btn i { margin-right: 5px; }
        
        .btn-edit { background-color: var(--color-warning); color: black; padding: 5px 10px; font-size: 0.9em;}
        .btn-delete { background-color: var(--color-danger); color: white; padding: 5px 10px; font-size: 0.9em;}

        /* è¡¨æ ¼ */
        .table-responsive { overflow-x: auto; }

        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .data-table th, .data-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #222; }
        .data-table th { background-color: #1A1A1A; color: var(--color-primary); }
        .data-table tbody tr:hover { background-color: #151515; }
        .data-table td { vertical-align: middle; }
        .thumb-img { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid #333; }
        .featured-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; }
        .featured-indicator.yes { background-color: var(--color-success); }
        .featured-indicator.no { background-color: var(--color-text-dim); }

        /* æ•¸æ“šåˆ†æå¡ç‰‡ */
        #statsGrid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;
        }
        .stat-card {
            background-color: #1A1A1A; padding: 20px; border-radius: 8px;
            border-left: 5px solid var(--color-primary); position: relative;
        }
        .stat-card h3 { font-size: 1.1em; color: var(--color-text-dim); margin: 0 0 10px 0; border: none; }
        .stat-card p { font-size: 2em; font-weight: bold; color: var(--color-text-light); }
        .stat-card .icon { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); font-size: 2.5em; color: var(--color-primary); opacity: 0.2; }

        /* è¡¨å–®èˆ‡è¼¸å…¥æ¡† */
        input[type="text"], input[type="password"], input[type="email"], input[type="number"], select, textarea {
            width: 100%; padding: 10px; background: #0A0A0A; border: 1px solid #333;
            color: white; border-radius: 3px; margin-bottom: 10px;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--color-primary); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

        /* å½ˆçª— (Modal) */
        .modal {
            display: none; position: fixed; z-index: 3000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(3px);
        }
        .modal-content {
            background-color: #1A1A1A; margin: 5% auto; padding: 30px;
            border: 1px solid var(--color-secondary); border-radius: 8px;
            width: 90%; max-width: 600px; position: relative;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; border: none; }
        .close-btn { color: var(--color-text-dim); font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-btn:hover { color: white; }
        #productImagePreview { max-width: 100%; height: auto; margin-top: 10px; border-radius: 5px; }

        /* ç³»çµ±è¨­å®šä½ˆå±€ */
        .settings-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        .settings-card {
            background-color: #1A1A1A;
            padding: 20px;
            border-radius: 8px;
        }
        .settings-card h3 { margin-top: 0; }

        /* éŸ¿æ‡‰å¼ */
        @media (max-width: 1200px) {
            #statsGrid { grid-template-columns: 1fr 1fr; }
        }
        @media (max-width: 960px) {
            .settings-layout { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .admin-layout { flex-direction: column; }
            .sidebar { width: 100%; border-right: none; border-bottom: 1px solid var(--color-secondary); }
            #statsGrid { grid-template-columns: 1fr; }
            .form-grid { grid-template-columns: 1fr; }
            .content-header { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>

    <div class="admin-layout">
        
        <aside class="sidebar">
            <h1><i class="fas fa-tachometer-alt"></i> å¾Œå°ç®¡ç†ä¸­å¿ƒ</h1>
            <nav>
                <ul>
                    <li class="nav-item"><a href="#" class="nav-link" data-tab="analytics"><i class="fas fa-chart-line"></i> æ•¸æ“šåˆ†æ</a></li>
                    <li class="nav-item"><a href="#" class="nav-link" data-tab="orders"><i class="fas fa-receipt"></i> è¨‚å–®ç®¡ç†</a></li>
                    <li class="nav-item"><a href="#" class="nav-link" data-tab="products"><i class="fas fa-box-open"></i> ç”¢å“ç®¡ç†</a></li>
                    <li class="nav-item"><a href="#" class="nav-link" data-tab="users"><i class="fas fa-users"></i> ä½¿ç”¨è€…ç®¡ç†</a></li>
                    <li class="nav-item"><a href="#" class="nav-link" data-tab="settings"><i class="fas fa-cog"></i> ç³»çµ±è¨­å®š</a></li>
                </ul>
            </nav>
            <div class="logout-section">
                <ul>
                    <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> ç™»å‡ºä¸¦è¿”å›é¦–é </a></li>
                </ul>
            </div>
        </aside>

        <main class="main-content">
            
            <div id="analytics" class="tab-content active">
                <div class="content-header">
                    <h2>ç¶²ç«™æ•¸æ“šåˆ†æ</h2>
                    <button class="btn btn-secondary" id="exportSalesButton"><i class="fas fa-file-csv"></i> åŒ¯å‡ºéŠ·å”®æ•¸æ“š</button>
                </div>
                
                <div id="statsGrid">
                    </div>

                <div class="form-grid">
                    <div>
                        <h3>å”®å‡ºå•†å“æ’è¡Œæ¦œ</h3>
                        <div class="table-responsive">
                            <table id="salesTable" class="data-table">
                                <thead>
                                    <tr>
                                        <th>å•†å“åç¨±</th>
                                        <th>ID</th>
                                        <th>å”®å‡ºæ•¸é‡</th>
                                        <th>éŠ·å”®é‡‘é¡</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    <div>
                        <h3>äº¤æ˜“æ¬¡æ•¸ (æœˆ/å¹´)</h3>
                        <div class="table-responsive">
                            <table id="transactionsTable" class="data-table">
                                <thead>
                                    <tr>
                                        <th>æœŸé–“</th>
                                        <th>äº¤æ˜“æ¬¡æ•¸</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="orders" class="tab-content">
                <div class="content-header">
                    <h2>è¨‚å–®ç®¡ç† (æ¨¡æ“¬è³‡æ–™)</h2>
                </div>
                <div class="table-responsive">
                    <table id="orderTable" class="data-table">
                        <thead>
                            <tr>
                                <th>è¨‚å–® ID</th>
                                <th>æ—¥æœŸ</th>
                                <th>æœƒå“¡</th>
                                <th>è³¼è²·å•†å“è©³æƒ…</th>
                                <th>ç¸½é‡‘é¡</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="products" class="tab-content">
                <div class="content-header">
                    <h2>ç”¢å“ç®¡ç†</h2>
                    <button class="btn btn-primary" id="addNewProductBtn"><i class="fas fa-plus"></i> æ–°å¢å•†å“</button>
                </div>
                <div class="table-responsive">
                    <table id="productTable" class="data-table">
                        <thead>
                            <tr>
                                <th>åœ–ç‰‡</th>
                                <th>ID</th>
                                <th>åç¨±</th>
                                <th>åƒ¹æ ¼</th>
                                <th>åº«å­˜</th>
                                <th>é¡¯ç¤ºæ–¼é¦–é  (ç†±éŠ·)</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>
            
            <div id="users" class="tab-content">
                <h2>ä½¿ç”¨è€…ç®¡ç†</h2>

                <h3>æœƒå“¡åˆ—è¡¨ (æ¨¡æ“¬è³‡æ–™ & ç¶²ç«™è¨»å†Š)</h3>
                <div class="content-header">
                    <span>æ­¤åˆ—è¡¨åŒ…å«æ¨¡æ“¬è³‡æ–™ï¼Œä»¥åŠå¾å‰å°è¨»å†Šçš„çœŸå¯¦æœƒå“¡ã€‚</span>
                    <div class="search-bar">
                        <input type="text" id="userSearchInput" placeholder="æœå°‹å§“åæˆ–å¸³è™Ÿ..." style="margin-bottom: 0;">
                        <button class="btn btn-secondary" id="userSearchButton"><i class="fas fa-search"></i></button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table id="userTable" class="data-table">
                        <thead>
                            <tr>
                                <th>ID / é¡å‹</th>
                                <th>å§“å</th>
                                <th>å¸³è™Ÿ (Email)</th>
                                <th>å¯†ç¢¼ (æ¨¡æ“¬åŠ å¯†)</th>
                                <th>ä¿®æ”¹å¯†ç¢¼</th>
                                <th>Email</th>
                                <th>ç¸½æ¶ˆè²» (æ¨¡æ“¬)</th>
                                <th>è³¼è²·ç´€éŒ„ (æ¨¡æ“¬)</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <h3>å‰å°è«®è©¢ç™»è¨˜ (LocalStorage: USER_REGISTRATIONS)</h3>
                <div class="content-header">
                    <span>æ­¤è™•é¡¯ç¤ºå‰å° "è«®è©¢" è¡¨å–®æäº¤çš„è³‡æ–™ (è‹¥æ‚¨æœ‰å¯¦ä½œæ­¤åŠŸèƒ½)ã€‚</span>
                    <button class="btn btn-danger" id="clearRegistrationsButton"><i class="fas fa-trash-alt"></i> æ¸…ç©ºè«®è©¢</button>
                </div>
                <div class="table-responsive">
                    <table id="registrationTable" class="data-table">
                        <thead>
                            <tr>
                                <th>ID / æ—¥æœŸ</th>
                                <th>å§“å</th>
                                <th>Email</th>
                                <th>é›»è©±</th>
                                <th>è«®è©¢é¡å‹</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="settings" class="tab-content">
                <h2>ç³»çµ±è¨­å®š</h2>

                <div class="settings-layout">
                    <div class="settings-card">
                        <h3>ä¸»è¦ç®¡ç†è€…å¯†ç¢¼ (admin)</h3>
                        <form id="adminPasswordForm">
                            <div class="form-group">
                                <label for="newAdminPassword">è¼¸å…¥æ–°å¯†ç¢¼</label>
                                <input type="password" id="newAdminPassword" required minlength="6">
                            </div>
                            <div class="form-group">
                                <label for="confirmAdminPassword">ç¢ºèªæ–°å¯†ç¢¼</label>
                                <input type="password" id="confirmAdminPassword" required minlength="6">
                            </div>
                            <button type="submit" class="btn btn-warning"><i class="fas fa-key"></i> è®Šæ›´ç®¡ç†è€…å¯†ç¢¼</button>
                        </form>
                    </div>
                    
                    <div class="settings-card">
                        <h3>ä¸»è¦ç®¡ç†è€…è³‡æ–™ (æ¨¡æ“¬)</h3>
                        <form id="adminProfileForm">
                            <div class="form-group">
                                <label for="adminAccount">ç®¡ç†è€…å¸³è™Ÿ</label>
                                <input type="text" id="adminAccount" value="admin">
                            </div>
                            <div class="form-group">
                                <label for="adminEmail">ç®¡ç†è€… Email</label>
                                <input type="email" id="adminEmail" value="admin@example.com">
                            </div>
                            <button type="submit" class="btn btn-secondary"><i class="fas fa-save"></i> å„²å­˜ç®¡ç†è€…è³‡æ–™</button>
                        </form>
                    </div>

                    <div class="settings-card">
                        <h3>å‰µå»ºç¬¬äºŒç®¡ç†è€… (æ¨¡æ“¬)</h3>
                        <p style="color: var(--color-text-dim); font-size: 0.9em;">æ­¤åŠŸèƒ½ç‚ºç¤ºç¯„ï¼ŒçœŸå¯¦æ¬Šé™ç®¡ç†éœ€è¦å¾Œç«¯è³‡æ–™åº«ã€‚</p>
                        <form id="secondAdminForm">
                            <div class="form-group">
                                <label for="secondAdminAccount">æ–°ç®¡ç†è€…å¸³è™Ÿ</label>
                                <input type="text" id="secondAdminAccount">
                            </div>
                            <div class="form-group">
                                <label for="secondAdminPassword">æ–°ç®¡ç†è€…å¯†ç¢¼</label>
                                <input type="password" id="secondAdminPassword">
                            </div>
                            <div class="form-group">
                                <label>æ¬Šé™ (æ¨¡æ“¬)</label>
                                <select>
                                    <option value="full">å®Œå…¨æ§åˆ¶</option>
                                    <option value="editor">ç·¨è¼¯è€… (å¯ç®¡ç†ç”¢å“/è¨‚å–®)</option>
                                    <option value="viewer">æª¢è¦–è€… (åƒ…å¯æŸ¥çœ‹)</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary"><i class="fas fa-user-plus"></i> å‰µå»ºå¸³æˆ¶</button>
                        </form>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">æ–°å¢å•†å“</h2>
                <span class="close-btn" id="closeProductModalBtn">&times;</span>
            </div>
            <form id="productForm">
                <input type="hidden" id="productId">
                <input type="hidden" id="productImageUrl">
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="productName">å•†å“åç¨±</label>
                        <input type="text" id="productName" name="title" required>
                    </div>
                    <div class="form-group">
                        <label for="productCategory">å•†å“åˆ†é¡</label>
                        <select id="productCategory" name="category" required>
                            <option value="Camera">é«˜æ¸…ç›£æ§ (Camera)</option>
                            <option value="Access">é–€ç¦ç³»çµ± (Access)</option>
                            <option value="Network">ç¶²è·¯è¨­å‚™ (Network)</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="productPrice">åƒ¹æ ¼</label>
                        <input type="number" id="productPrice" name="price" required min="0">
                    </div>
                    <div class="form-group">
                        <label for="productStock">åº«å­˜</label>
                        <input type="number" id="productStock" name="stock" required min="0">
                    </div>
                </div>

                <div class="form-group">
                    <label for="productDescription">å•†å“æè¿°</label>
                    <textarea id="productDescription" name="description" rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label for="productImageFile">ä¸Šå‚³åœ–ç‰‡ (æˆ–è²¼å…¥ Base64)</label>
                    <input type="file" id="productImageFile" accept="image/*">
                    <img id="productImagePreview" src="" alt="Image Preview" style="display:none; max-width: 200px; margin-top: 10px;">
                </div>
                
                <div class="form-group">
                    <input type="checkbox" id="productIsFeatured" name="isFeatured" style="width: auto; margin-bottom: 0;">
                    <label for="productIsFeatured" style="display: inline; margin-left: 10px;">
                        è¨­ç‚ºé¦–é ç†±éŠ·å•†å“ (Featured)
                    </label>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px;"><i class="fas fa-save"></i> å„²å­˜</button>
            </form>
        </div>
    </div>

    <div id="passwordModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 id="modalUserNameDisplay">è®Šæ›´å¯†ç¢¼</h2>
                <span class="close-btn" id="closePasswordModalBtn">&times;</span>
            </div>
            <form id="individualPasswordForm">
                <input type="hidden" id="modalUserId">
                <div class="form-group">
                    <label for="newIndividualPassword">è¼¸å…¥æ–°å¯†ç¢¼</label>
                    <input type="password" id="newIndividualPassword" required minlength="6">
                </div>
                <div class="form-group">
                    <label for="confirmIndividualPassword">ç¢ºèªæ–°å¯†ç¢¼</label>
                    <input type="password" id="confirmIndividualPassword" required minlength="6">
                </div>
                <button type="submit" class="btn btn-warning" style="width: 100%; padding: 12px;"><i class="fas fa-key"></i> ç¢ºèªè®Šæ›´</button>
            </form>
        </div>
    </div>

    <script>
        // ====================================
        // æ ¸å¿ƒè³‡æ–™èˆ‡å„²å­˜ (ä½¿ç”¨ LocalStorage æ¨¡æ“¬è³‡æ–™åº«)
        // ====================================

        // ç”¢å“åˆå§‹è³‡æ–™ (ğŸ’¡ *** èªæ³•ä¿®æ­£ ***)
        // ä¿®æ­£ï¼šå¤–å±¤æ”¹ç”¨é›™å¼•è™Ÿ (")ï¼Œå…§å±¤ä½¿ç”¨å–®å¼•è™Ÿ (')
        const INITIAL_PRODUCTS_DATA = [
            { id: "CAM001", title: "æ¥µå…‰ Pro 4K ç¶²è·¯æ”å½±æ©Ÿ", category: "Camera", categoryText: "é«˜æ¸…ç›£æ§", price: 8990, description: "...", image: "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%231f1f1f'/><circle cx='50' cy='45' r='20' fill='%2300ffff'/><path d='M30 65H70L50 85Z' fill='%2300ffff'/><text x='50' y='95' font-size='10' fill='%23aaa' text-anchor='middle'>Camera 001</text></svg>", stock: 10, isFeatured: true },
            { id: "ACC002", title: "æ™ºèƒ½æŒ‡ç´‹è¾¨è­˜é–", category: "Access", categoryText: "é–€ç¦ç³»çµ±", price: 12500, description: "...", image: "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%231f1f1f'/><rect x='30' y='30' width='40' height='40' rx='5' fill='%230077b6'/><path d='M40 40H60V60H40Z' fill='white'/><text x='50' y='95' font-size='10' fill='%23aaa' text-anchor='middle'>Access 002</text></svg>", stock: 5, isFeatured: true },
            { id: "NET003", title: "ä¼æ¥­ç´š Wi-Fi 6 è·¯ç”±å™¨", category: "Network", categoryText: "ç¶²è·¯è¨­å‚™", price: 5200, description: "...", image: "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%231f1f1f'/><rect x='20' y='40' width='60' height='20' rx='2' fill='%2300ffff'/><path d='M30 40V20M70 40V20' stroke='%2300ffff' stroke-width='3'/><text x='50' y='95' font-size='10' fill='%23aaa' text-anchor='middle'>Network 003</text></svg>", stock: 20, isFeatured: true },
            { id: "CAM004", title: "è¶…å»£è§’é­šçœ¼ç›£æ§å™¨", category: "Camera", categoryText: "é«˜æ¸…ç›£æ§", price: 6500, description: "...", image: "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%231f1f1f'/><circle cx='50' cy='50' r='35' fill='%2300ffff20' stroke='%2300ffff' stroke-width='2'/><circle cx='50' cy='50' r='5' fill='%2300ffff'/><text x='50' y='95' font-size='10' fill='%23aaa' text-anchor='middle'>Camera 004</text></svg>", stock: 3, isFeatured: false },
            { id: "NET005", title: "Cat.6A ç„¡æ°§éŠ…ç¶²è·¯ç·š", category: "Network", categoryText: "ç¶²è·¯ä½ˆç·š", price: 850, description: "...", image: "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%231f1f1f'/><path d='M20 50C40 30 60 70 80 50' stroke='%230077b6' stroke-width='5' fill='none'/><text x='50' y='95' font-size='10' fill='%23aaa' text-anchor='middle'>Cable 005</text></svg>", stock: 50, isFeatured: false },
            { id: "ACC006", title: "RFID é–€ç¦è®€å¡æ©Ÿ", category: "Access", categoryText: "é–€ç¦ç³»çµ±", price: 1800, description: "...", image: "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%231f1f1f'/><rect x='30' y='35' width='40' height='30' rx='2' fill='%230077b6'/><path d='M40 40L60 60M60 40L40 60' stroke='white' stroke-width='2'/><text x='50' y='95' font-size='10' fill='%23aaa' text-anchor='middle'>RFID 006</text></svg>", stock: 0, isFeatured: false }
        ];

        // æ¨¡æ“¬è¨‚å–®è³‡æ–™ (ä¸è®Š)
        const MOCK_ORDERS_DATA = [
            { id: 10, memberId: 108, date: '2024-12-05', total: 12500, items: [{ productId: 'ACC002', qty: 1, price: 12500 }] },
            { id: 11, memberId: 101, date: '2024-12-30', total: 17980, items: [{ productId: 'CAM001', qty: 2, price: 8990 }] },
            { id: 1, memberId: 101, date: '2025-01-15', total: 8990, items: [{ productId: 'CAM001', qty: 1, price: 8990 }] },
            { id: 2, memberId: 102, date: '2025-01-20', total: 12500, items: [{ productId: 'ACC002', qty: 1, price: 12500 }] },
            { id: 3, memberId: 101, date: '2025-02-01', total: 17980, items: [{ productId: 'CAM001', qty: 2, price: 8990 }] },
            { id: 4, memberId: 103, date: '2025-03-05', total: 5200, items: [{ productId: 'NET003', qty: 1, price: 5200 }] },
            { id: 5, memberId: 104, date: '2025-03-20', total: 6500, items: [{ productId: 'CAM004', qty: 1, price: 6500 }] },
            { id: 6, memberId: 102, date: '2025-04-10', total: 850 * 5, items: [{ productId: 'NET005', qty: 5, price: 850 }] },
            { id: 7, memberId: 105, date: '2025-05-01', total: 8990, items: [{ productId: 'CAM001', qty: 1, price: 8990 }] },
            { id: 8, memberId: 106, date: '2025-05-25', total: 1800, items: [{ productId: 'ACC006', qty: 1, price: 1800 }] },
            { id: 9, memberId: 107, date: '2025-06-10', total: 5200, items: [{ productId: 'NET003', qty: 1, price: 5200 }] },
        ];

        // æ¨¡æ“¬ä½¿ç”¨è€…è³‡æ–™
        const MOCK_MEMBERS_DATA = [
            { id: 101, name: "é™³å°æ˜", account: "chen.x.m", password: "encrypted_123", email: "chen@example.com" },
            { id: 102, name: "æ—ç¾è¯", account: "lin.m.h", password: "encrypted_456", email: "lin@example.com" },
            { id: 103, name: "ç‹å¤§å±±", account: "wang.d.s", password: "encrypted_789", email: "wang@example.com" },
            { id: 104, name: "å¼µå¿—å‰", account: "zhang.z.w", password: "encrypted_abc", email: "zhang@example.com" },
            { id: 105, name: "å³é›…å©·", account: "wu.y.t", password: "encrypted_def", email: "wu@example.com" },
            { id: 106, name: "è¨±å®¶è±ª", account: "xu.j.h", password: "encrypted_ghi", email: "xu@example.com" },
            { id: 107, name: "å‘¨å®œéœ", account: "zhou.y.j", password: "encrypted_jkl", email: "zhou@example.com" },
            { id: 108, name: "ææ–‡å‚‘", account: "li.w.j", password: "encrypted_mno", email: "li@example.com" }
        ];

        let PRODUCTS = [];
        let ALL_USERS = []; // å„²å­˜è™•ç†å¾Œçš„æœƒå“¡è³‡æ–™
        let currentModalMode = 'add';

        // è¼‰å…¥èˆ‡å„²å­˜è³‡æ–™ (ä¸è®Š)
        function loadData() {
            try {
                const storedProducts = localStorage.getItem('adminProducts');
                if (storedProducts) {
                    PRODUCTS = JSON.parse(storedProducts);
                } else {
                    PRODUCTS = INITIAL_PRODUCTS_DATA;
                    saveProducts();
                }
            } catch (e) {
                console.error("Error loading product data:", e);
                PRODUCTS = INITIAL_PRODUCTS_DATA;
            }
        }
        
        // ğŸ’¡ *** æ–°å¢ Try...Catch é˜²è­· ***
        function saveProducts() {
            try {
                localStorage.setItem('adminProducts', JSON.stringify(PRODUCTS));
            } catch (e) {
                console.error("Error saving product data to localStorage:", e);
                alert("è­¦å‘Šï¼šç„¡æ³•å„²å­˜ç”¢å“è³‡æ–™ï¼Œå¯èƒ½æ˜¯ç€è¦½å™¨éš±ç§è¨­å®šæˆ–å„²å­˜ç©ºé–“å·²æ»¿ã€‚");
            }
        }

        // ====================================
        // NEW: è¨»å†Š/è«®è©¢è³‡æ–™è®€å–èˆ‡ç®¡ç†
        // ====================================

        function loadRegistrations() {
            try {
                const storedRegistrations = localStorage.getItem('USER_REGISTRATIONS');
                return storedRegistrations ? JSON.parse(storedRegistrations) : [];
            } catch (e) {
                console.error("Error loading registration data:", e);
                return [];
            }
        }

        function clearRegistrations() {
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å‰å°è«®è©¢ç™»è¨˜å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                try {
                    localStorage.removeItem('USER_REGISTRATIONS');
                    alert('å‰å°è«®è©¢ç™»è¨˜å·²å…¨éƒ¨æ¸…ç©ºï¼');
                    renderRegistrationTable(); // é‡æ–°æ¸²æŸ“è¡¨æ ¼
                } catch (e) {
                    console.error("Error clearing registrations:", e);
                    alert("éŒ¯èª¤ï¼šç„¡æ³•æ¸…ç©ºè«®è©¢è³‡æ–™ã€‚");
                }
            }
        }

        const REG_TYPE_MAP = {
            'service': 'é ç´„ç¾å ´å‹˜æŸ¥/æœå‹™è«®è©¢',
            'product': 'ç”¢å“è³¼è²·/è¦æ ¼è©¢å•',
            'other': 'å…¶ä»–'
        };

        function renderRegistrationTable() {
            const tableBody = document.querySelector('#registrationTable tbody');
            if (!tableBody) return;
            
            const registrations = loadRegistrations().reverse(); 
            tableBody.innerHTML = '';
            
            if (registrations.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: var(--color-text-dim);">ç›®å‰å°šç„¡æ–°çš„å‰å°è«®è©¢ç™»è¨˜ (LocalStorage: USER_REGISTRATIONS)</td></tr>';
                return;
            }

            registrations.forEach(reg => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>
                        <span style="font-size: 0.8em; color: var(--color-text-dim);">${reg.date}</span><br>
                        <span style="font-weight: bold; color: var(--color-primary);">${reg.id.substring(0, 12)}...</span>
                    </td>
                    <td>${reg.name}</td>
                    <td><a href="mailto:${reg.email}" style="color: var(--color-primary);">${reg.email}</a></td>
                    <td>${reg.phone}</td>
                    <td>
                        <span style="color: ${reg.type === 'service' ? 'var(--color-success)' : 'var(--color-secondary)'}; font-weight: bold;">
                            ${REG_TYPE_MAP[reg.type] || reg.type}
                        </span>
                    </td>
                `;
            });
        }


        /**
         * æº–å‚™ä½¿ç”¨è€…æ•¸æ“š
         */
        function prepareUserData() {
            const userStats = {};
            
            MOCK_MEMBERS_DATA.forEach(user => {
                userStats[user.id] = { totalConsumption: 0, purchasedItems: {} };
            });

            MOCK_ORDERS_DATA.forEach(order => {
                const stats = userStats[order.memberId];
                if (stats) {
                    stats.totalConsumption += order.total;
                    order.items.forEach(item => {
                        const product = PRODUCTS.find(p => p.id === item.productId);
                        const productName = product ? product.title : 'æœªçŸ¥å•†å“';
                        if (!stats.purchasedItems[productName]) {
                            stats.purchasedItems[productName] = { qty: 0, id: item.productId };
                        }
                        stats.purchasedItems[productName].qty += item.qty;
                    });
                }
            });

            const mockUsers = MOCK_MEMBERS_DATA.map(user => {
                const stats = userStats[user.id] || { totalConsumption: 0, purchasedItems: {} };
                const purchasedList = Object.keys(stats.purchasedItems).map(name => {
                    return `${name} (x${stats.purchasedItems[name].qty})`;
                }).join('; ');

                const storedPassword = localStorage.getItem(`userPassword_${user.id}`);
                const currentPassword = storedPassword || user.password;
                
                return {
                    ...user,
                    password: currentPassword, 
                    totalConsumption: stats.totalConsumption,
                    purchasedItemsText: purchasedList || 'ç„¡è³¼è²·ç´€éŒ„',
                    isRegistration: false 
                };
            });
            
            let storedRealUsers = [];
            try {
                const storedData = localStorage.getItem('userManagementData');
                storedRealUsers = storedData ? JSON.parse(storedData) : [];
            } catch (e) {
                console.error("Error parsing userManagementData:", e);
                storedRealUsers = [];
            }
            
            const realUsers = storedRealUsers.map(regUser => {
                const mockUserForOrders = MOCK_MEMBERS_DATA.find(m => m.email === regUser.email);
                let consumption = 0;
                let itemsText = 'ç„¡è³¼è²·ç´€éŒ„';

                if (mockUserForOrders) {
                    const stats = userStats[mockUserForOrders.id] || { totalConsumption: 0, purchasedItems: {} };
                    consumption = stats.totalConsumption;
                    itemsText = Object.keys(stats.purchasedItems).map(name => {
                        return `${name} (x${stats.purchasedItems[name].qty})`;
                    }).join('; ') || 'ç„¡è³¼è²·ç´€éŒ„';
                }

                const storedPassword = localStorage.getItem(`userPassword_${regUser.id}`);
                const currentPassword = storedPassword || regUser.password; 

                return {
                    id: regUser.id, 
                    name: regUser.name,
                    account: regUser.email, 
                    password: currentPassword, 
                    email: regUser.email,
                    totalConsumption: consumption, 
                    purchasedItemsText: itemsText, 
                    isRegistration: true 
                };
            });

            const realUserEmails = new Set(realUsers.map(u => u.email));
            const filteredMockUsers = mockUsers.filter(u => !realUserEmails.has(u.email));

            ALL_USERS = [...realUsers, ...filteredMockUsers];
        }


        /**
         * è™•ç†æª”æ¡ˆè¼¸å…¥é è¦½
         */
        function previewImage(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            const preview = document.getElementById('productImagePreview');
            const urlInput = document.getElementById('productImageUrl');

            if (!file || !preview || !urlInput) return;

            reader.onload = function(e) {
                const dataUrl = e.target.result;
                preview.src = dataUrl;
                preview.style.display = 'block';
                urlInput.value = dataUrl; 
            };
            reader.readAsDataURL(file);
        }


        // ====================================
        // 1. å•†å“ç®¡ç† (CRUD) é‚è¼¯ 
        // ====================================
        function renderProductTable() {
            const tableBody = document.querySelector('#productTable tbody');
            if (!tableBody) return;
            tableBody.innerHTML = '';

            PRODUCTS.forEach(product => {
                const featuredStatus = product.isFeatured ? 
                    '<span class="featured-indicator yes" title="æ˜¯"></span> æ˜¯' : 
                    '<span class="featured-indicator no" title="å¦"></span> å¦';

                const row = tableBody.insertRow();
                // ğŸ’¡ *** èªæ³•ä¿®æ­£ ***
                const imageSrc = product.image || "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23555'/><text x='50' y='50' font-size='10' fill='%23fff' text-anchor='middle'>No Image</text></svg>";
                row.innerHTML = `
                    <td>
                        <img src="${imageSrc}" 
                            alt="åœ–" class="thumb-img">
                    </td>
                    <td>${product.id}</td>
                    <td>${product.title}</td>
                    <td>NT$ ${product.price.toLocaleString()}</td>
                    <td>${product.stock}</td>
                    <td>${featuredStatus}</td>
                    <td>
                        <button class="btn btn-edit" onclick="openProductModal('edit', '${product.id}')"><i class="fas fa-edit"></i> ç·¨è¼¯</button>
                        <button class="btn btn-delete" onclick="deleteProduct('${product.id}')"><i class="fas fa-trash"></i> åˆªé™¤</button>
                    </td>
                `;
            });
        }

        function openProductModal(mode, id = null) {
            const modal = document.getElementById('productModal');
            const form = document.getElementById('productForm');
            const title = document.getElementById('modalTitle');
            const preview = document.getElementById('productImagePreview');
            const imageFile = document.getElementById('productImageFile');
            
            if (!modal || !form || !title || !preview || !imageFile) {
                console.error("openProductModal: æ‰¾ä¸åˆ°å¿…è¦çš„ HTML å…ƒç´ ã€‚");
                return;
            }
            
            form.reset(); 
            imageFile.value = ''; 
            preview.style.display = 'none';
            preview.src = '';

            currentModalMode = mode;
            title.textContent = mode === 'add' ? 'æ–°å¢å•†å“' : 'ç·¨è¼¯å•†å“';
            
            if (mode === 'edit' && id) {
                const product = PRODUCTS.find(p => p.id === id);
                if (product) {
                    document.getElementById('productId').value = product.id;
                    document.getElementById('productName').value = product.title;
                    document.getElementById('productCategory').value = product.category;
                    document.getElementById('productPrice').value = product.price;
                    document.getElementById('productStock').value = product.stock;
                    document.getElementById('productDescription').value = product.description;
                    document.getElementById('productIsFeatured').checked = !!product.isFeatured;
                    document.getElementById('productImageUrl').value = product.image || '';
                    if (product.image) {
                        preview.src = product.image;
                        preview.style.display = 'block';
                    }
                }
            } else if (mode === 'add') {
                document.getElementById('productId').value = '';
                document.getElementById('productIsFeatured').checked = false; 
                document.getElementById('productImageUrl').value = '';
            }

            modal.style.display = 'block';
        }

        function closeProductModal() {
            const modal = document.getElementById('productModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function deleteProduct(id) {
            if (confirm(`ç¢ºå®šè¦åˆªé™¤å•†å“ ID: ${id} å—ï¼Ÿ`)) {
                PRODUCTS = PRODUCTS.filter(p => p.id !== id);
                saveProducts();
                renderProductTable();
                alert('å•†å“å·²åˆªé™¤ï¼');
            }
        }


        // ====================================
        // 2. æ•¸æ“šåˆ†æ (Analytics) é‚è¼¯
        // ====================================
        function calculateAnalytics() {
            let totalSalesAmount = 0;
            const productSales = {}; 
            const monthlyTransactions = {}; 
            const yearlyTransactions = {}; 

            MOCK_ORDERS_DATA.forEach(order => {
                totalSalesAmount += order.total;
                const date = new Date(order.date);
                const yearMonth = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                const year = date.getFullYear().toString();
                monthlyTransactions[yearMonth] = (monthlyTransactions[yearMonth] || 0) + 1;
                yearlyTransactions[year] = (yearlyTransactions[year] || 0) + 1;

                order.items.forEach(item => {
                    if (!productSales[item.productId]) {
                        const product = PRODUCTS.find(p => p.id === item.productId) || { title: 'æœªçŸ¥å•†å“', price: 0 };
                        productSales[item.productId] = { 
                            title: product.title, 
                            qty: 0, 
                            amount: 0,
                            id: item.productId 
                        };
                    }
                    productSales[item.productId].qty += item.qty;
                    productSales[item.productId].amount += item.qty * item.price;
                });
            });

            const salesArray = Object.values(productSales)
                .filter(p => p.qty > 0)
                .sort((a, b) => b.qty - a.qty); 

            const totalMemberCount = ALL_USERS.length;

            return {
                memberCount: totalMemberCount, 
                totalSalesAmount,
                salesArray,
                monthlyTransactions,
                yearlyTransactions
            };
        }

        function renderAnalytics() {
            prepareUserData(); 
            const data = calculateAnalytics();
            
            const statsGrid = document.getElementById('statsGrid');
            const salesTableBody = document.querySelector('#salesTable tbody');
            const transactionsTableBody = document.querySelector('#transactionsTable tbody');
            
            if (!statsGrid || !salesTableBody || !transactionsTableBody) return;
            
            statsGrid.innerHTML = `
                <div class="stat-card"><h3>ç¸½æœƒå“¡æ•¸</h3><p>${data.memberCount.toLocaleString()}</p><span class="icon"><i class="fas fa-users"></i></span></div>
                <div class="stat-card" style="border-left-color: var(--color-success);"><h3>å”®å‡ºç¸½é‡‘é¡ (æ¨¡æ“¬)</h3><p>NT$ ${data.totalSalesAmount.toLocaleString()}</p><span class="icon" style="color: var(--color-success);"><i class="fas fa-dollar-sign"></i></span></div>
                <div class="stat-card" style="border-left-color: var(--color-secondary);"><h3>ç¸½ç”¢å“æ•¸</h3><p>${PRODUCTS.length}</p><span class="icon" style="color: var(--color-secondary);"><i class="fas fa-box-open"></i></span></div>
                <div class="stat-card" style="border-left-color: var(--color-warning);"><h3>ç¸½äº¤æ˜“æ¬¡æ•¸ (æ¨¡æ“¬)</h3><p>${MOCK_ORDERS_DATA.length}</p><span class="icon" style="color: var(--color-warning);"><i class="fas fa-receipt"></i></span></div>
            `;

            salesTableBody.innerHTML = '';
            if (data.salesArray.length === 0) {
                salesTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">å°šç„¡ä»»ä½•éŠ·å”®æ•¸æ“š</td></tr>';
            } else {
                data.salesArray.forEach(sale => {
                    const row = salesTableBody.insertRow();
                    row.innerHTML = `
                        <td>${sale.title}</td>
                        <td>${sale.id}</td>
                        <td>${sale.qty.toLocaleString()}</td>
                        <td>NT$ ${sale.amount.toLocaleString()}</td>
                    `;
                });
            }

            transactionsTableBody.innerHTML = '';
            Object.keys(data.yearlyTransactions).sort().reverse().forEach(year => {
                const row = transactionsTableBody.insertRow();
                row.innerHTML = `
                    <td><strong>${year} å¹´åº¦ç¸½è¨ˆ</strong></td>
                    <td><strong>${data.yearlyTransactions[year].toLocaleString()} æ¬¡</strong></td>
                `;
            });
            Object.keys(data.monthlyTransactions)
                .sort().reverse() 
                .forEach(monthKey => {
                    const [year, month] = monthKey.split('-');
                    const row = transactionsTableBody.insertRow();
                    row.innerHTML = `
                        <td style="padding-left: 20px;">${year} å¹´ ${parseInt(month)} æœˆ</td>
                        <td>${data.monthlyTransactions[monthKey].toLocaleString()} æ¬¡</td>
                    `;
                });
        }

        function exportSalesData() {
            const data = calculateAnalytics().salesArray;
            let csvContent = "å•†å“åç¨±,å•†å“ID,å”®å‡ºæ•¸é‡,éŠ·å”®é‡‘é¡\n";
            
            data.forEach(item => {
                csvContent += `"${item.title.replace(/"/g, '""')}",${item.id},${item.qty},${item.amount}\n`;
            });
            
            const blob = new Blob([new TextDecoder('utf-8').decode(new Uint8Array([0xEF, 0xBB, 0xBF, ...new TextEncoder('utf-8').encode(csvContent)]))], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            
            if (link.download !== undefined) { 
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "éŠ·å”®æ•¸æ“šå ±è¡¨_" + new Date().toISOString().slice(0, 10) + ".csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                alert('éŠ·å”®æ•¸æ“šå·²åŒ¯å‡ºç‚º CSV æª”æ¡ˆï¼');
            } else {
                alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æŒè‡ªå‹•åŒ¯å‡ºåŠŸèƒ½ã€‚');
            }
        }


        // ====================================
        // 3. è¨‚å–®ç®¡ç† (Order Management) (æ–°)
        // ====================================
        function renderOrderTable() {
            const tableBody = document.querySelector('#orderTable tbody');
            if (!tableBody) return;
            tableBody.innerHTML = '';
            
            if (!PRODUCTS || PRODUCTS.length === 0) {
                loadData();
            }

            const orders = MOCK_ORDERS_DATA.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (orders.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">å°šç„¡ä»»ä½•è¨‚å–®è³‡æ–™ (MOCK_ORDERS_DATA)</td></tr>';
                return;
            }

            orders.forEach(order => {
                const itemsHtml = order.items.map(item => {
                    const product = PRODUCTS.find(p => p.id === item.productId);
                    const title = product ? product.title : 'æœªçŸ¥å•†å“';
                    return `<li style="font-size: 0.9em;">${title} (x${item.qty}) - NT$ ${item.price.toLocaleString()}</li>`;
                }).join('');

                const member = MOCK_MEMBERS_DATA.find(m => m.id === order.memberId);
                const memberName = member ? member.name : 'æœªçŸ¥æœƒå“¡';
                
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${order.id}</td>
                    <td>${order.date}</td>
                    <td>${memberName} (ID: ${order.memberId})</td>
                    <td>
                        <ul style="padding-left: 15px; margin: 0; max-width: 300px;">${itemsHtml}</ul>
                    </td>
                    <td style="font-weight: bold; color: var(--color-primary);">NT$ ${order.total.toLocaleString()}</td>
                `;
            });
        }


        // ====================================
        // 4. ä½¿ç”¨è€…ç®¡ç† (User Management)
        // ====================================

        function renderUserTable(usersToRender) {
            const tableBody = document.querySelector('#userTable tbody');
            if (!tableBody) return;
            
            const usersToDisplay = usersToRender;
            tableBody.innerHTML = '';
            
            if (usersToDisplay.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" style="text-align:center;">æ‰¾ä¸åˆ°ä»»ä½•ä½¿ç”¨è€… (è«‹å˜—è©¦å¾å‰å°è¨»å†Š)</td></tr>';
                return;
            }

            usersToDisplay.forEach(user => {
                const row = tableBody.insertRow();
                const userType = user.isRegistration ? 
                    '<span style="color: var(--color-success); font-weight: bold;">[è¨»å†Šæœƒå“¡]</span>' : 
                    '<span style="color: var(--color-text-dim); font-style: italic;">[æ¨¡æ“¬è³‡æ–™]</span>';

                row.innerHTML = `
                    <td>${user.id} ${userType}</td>
                    <td>${user.name}</td>
                    <td>${user.account}</td>
                    <td><span title="å¯†ç¢¼(æ˜æ–‡/æ¨¡æ“¬åŠ å¯†)">${user.password}</span></td>
                    <td>
                        <button class="btn btn-edit" onclick="openPasswordModal('${user.id}', '${user.name}')" style="padding: 5px 10px; background-color: var(--color-warning); color: black; font-weight: bold;">
                            <i class="fas fa-sync"></i> è®Šæ›´
                        </button>
                    </td>
                    <td>${user.email}</td>
                    <td>NT$ ${user.totalConsumption.toLocaleString()}</td>
                    <td title="${user.purchasedItemsText.replace(/; /g, '\n')}">${user.purchasedItemsText}</td>
                `;
            });
        }

        function searchUsers() {
            const queryInput = document.getElementById('userSearchInput');
            if (!queryInput) return;
            
            const query = queryInput.value.toLowerCase().trim();
            if (!query) {
                renderUserTable(ALL_USERS); 
                return;
            }
            
            const filteredUsers = ALL_USERS.filter(user => 
                (user.name.toLowerCase().includes(query) || 
                 user.account.toLowerCase().includes(query))
            );

            renderUserTable(filteredUsers);
        }

        function openPasswordModal(userId, userName) {
            const modal = document.getElementById('passwordModal');
            const userIdInput = document.getElementById('modalUserId');
            const userNameDisplay = document.getElementById('modalUserNameDisplay');
            
            if (!modal || !userIdInput || !userNameDisplay) {
                 console.error("openPasswordModal: æ‰¾ä¸åˆ°å¿…è¦çš„ HTML å…ƒç´ ã€‚");
                return;
            }
            
            userIdInput.value = userId;
            userNameDisplay.textContent = `æ­£åœ¨ç‚ºä½¿ç”¨è€… [${userName}] è®Šæ›´å¯†ç¢¼`;
            document.getElementById('newIndividualPassword').value = '';
            document.getElementById('confirmIndividualPassword').value = '';
            modal.style.display = 'block';
        }

        function closePasswordModal() {
            const modal = document.getElementById('passwordModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }


        // ====================================
        // 5. ç™»å‡ºèˆ‡ç¸½æ§ 
        // ====================================

        function handleLogout() {
            if (confirm('ç¢ºå®šè¦ç™»å‡ºç®¡ç†è€…å¸³è™Ÿå—ï¼Ÿ')) {
                try {
                    sessionStorage.removeItem('isLoggedIn');
                    sessionStorage.removeItem('currentUserName');
                } catch(e) {
                    console.error("ç„¡æ³•æ¸…é™¤ sessionStorage:", e);
                }
                window.location.href = 'index.html'; 
            }
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });

            const activeTab = document.getElementById(tabId);
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            const navLink = document.querySelector(`.nav-link[data-tab="${tabId}"]`);
            if (navLink) {
                navLink.classList.add('active');
            }

            // ğŸ’¡ *** åœ¨åˆ‡æ›æ™‚æ‰è¼‰å…¥æ•¸æ“š ***
            try {
                if (tabId === 'products') {
                    renderProductTable();
                } else if (tabId === 'analytics') {
                    renderAnalytics();
                } else if (tabId === 'orders') {
                    renderOrderTable();
                } else if (tabId === 'users') { 
                    prepareUserData(); // åƒ…åœ¨é»æ“Šæ™‚æ‰æº–å‚™
                    renderUserTable(ALL_USERS); 
                    renderRegistrationTable(); 
                }
            } catch (e) {
                console.error(`è¼‰å…¥ ${tabId} åˆ†é æ™‚å‡ºéŒ¯:`, e);
                alert(`è¼‰å…¥ ${tabId} åˆ†é æ™‚å‡ºéŒ¯ï¼Œè«‹æª¢æŸ¥ä¸»æ§å° (F12)`);
            }
        }

        // ====================================
        // 7. ç¨‹å¼é€²å…¥é» (Entry Point)
        // ====================================

        document.addEventListener('DOMContentLoaded', function() {
            
            // ğŸ’¡ *** ç™»å…¥é©—è­‰å·²ä¾ç…§æ‚¨çš„è¦æ±‚è¢«ç§»é™¤ (è¨»è§£æ‰) ***
            /*
            const isLoggedIn = sessionStorage.getItem('isLoggedIn');
            if (isLoggedIn !== 'admin') {
                alert('æ‚¨ç„¡æ¬Šè¨ªå•æ­¤é é¢ï¼Œè«‹å…ˆå¾é¦–é ç™»å…¥ç®¡ç†è€…å¸³è™Ÿã€‚');
                window.location.href = 'index.html';
                return; // åœæ­¢åŸ·è¡Œå¾ŒçºŒè…³æœ¬
            }
            */
            
            // ğŸ’¡ *** åŠ ä¸Š Try...Catch é˜²è­· ***
            try {
                loadData(); 
                prepareUserData(); 
            } catch (e) {
                console.error("å•Ÿå‹•æ™‚è¼‰å…¥åŸºç¤è³‡æ–™å¤±æ•—:", e);
                alert("è¼‰å…¥åŸºç¤è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼ŒåŠŸèƒ½å¯èƒ½ä¸å®Œæ•´ã€‚");
            }


            // --- ç¶å®šæ‰€æœ‰äº‹ä»¶ç›£è½å™¨ ---

            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    switchTab(this.getAttribute('data-tab'));
                });
            });
            
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    handleLogout();
                });
            }

            const exportSalesBtn = document.getElementById('exportSalesButton');
            if (exportSalesBtn) {
                exportSalesBtn.addEventListener('click', exportSalesData);
            }

            const userSearchBtn = document.getElementById('userSearchButton');
            if (userSearchBtn) {
                userSearchBtn.addEventListener('click', searchUsers);
            }
            
            const clearRegBtn = document.getElementById('clearRegistrationsButton');
            if (clearRegBtn) {
                clearRegBtn.addEventListener('click', clearRegistrations);
            }

            const addNewProductBtn = document.getElementById('addNewProductBtn');
            if (addNewProductBtn) {
                addNewProductBtn.addEventListener('click', () => openProductModal('add'));
            }

            const productForm = document.getElementById('productForm');
            if (productForm) {
                productForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const form = e.target;
                    const id = form.productId.value;
                    const title = form.title.value;
                    const category = form.category.value;
                    const price = parseInt(form.price.value, 10);
                    const stock = parseInt(form.stock.value, 10);
                    const description = form.description.value;
                    const imageBase64 = form.image.value;
                    const isFeatured = form.isFeatured.checked;

                    const getNewId = () => 'PROD' + (PRODUCTS.length + 10).toString().padStart(3, '0');
                    const newId = currentModalMode === 'add' ? getNewId() : id;
                    const categoryText = form.productCategory.options[form.productCategory.selectedIndex].text.split('(')[0];

                    // ğŸ’¡ *** èªæ³•ä¿®æ­£ ***
                    const defaultImage = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23555'/><text x='50' y='50' font-size='10' fill='%23fff' text-anchor='middle'>No Image</text></svg>";

                    const newProduct = {
                        id: newId, title, category, categoryText: categoryText,
                        price, description, stock, isFeatured,
                        image: imageBase64 || defaultImage
                    };

                    if (currentModalMode === 'add') {
                        PRODUCTS.push(newProduct);
                        alert('å•†å“æ–°å¢æˆåŠŸï¼');
                    } else if (currentModalMode === 'edit') {
                        const index = PRODUCTS.findIndex(p => p.id === id);
                        if (index !== -1) {
                            PRODUCTS[index] = newProduct;
                            alert('å•†å“ç·¨è¼¯æˆåŠŸï¼');
                        }
                    }

                    saveProducts();
                    renderProductTable();
                    closeProductModal();
                });
            }
            
            const closeProductModalBtn = document.getElementById('closeProductModalBtn');
            if(closeProductModalBtn) {
                closeProductModalBtn.addEventListener('click', closeProductModal);
            }
            
            const productImageFile = document.getElementById('productImageFile');
            if (productImageFile) {
                productImageFile.addEventListener('change', previewImage);
            }

            const indPasswordForm = document.getElementById('individualPasswordForm');
            if (indPasswordForm) {
                indPasswordForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const userId = document.getElementById('modalUserId').value;
                    const newPwd = document.getElementById('newIndividualPassword').value;
                    const confirmPwd = document.getElementById('confirmIndividualPassword').value;

                    if (newPwd !== confirmPwd) {
                        alert('å…©æ¬¡è¼¸å…¥çš„æ–°å¯†ç¢¼ä¸ä¸€è‡´ï¼');
                        return;
                    }
                    if (newPwd.length < 6) {
                        alert('å¯†ç¢¼é•·åº¦å¿…é ˆè‡³å°‘ç‚º 6 ä½ã€‚');
                        return;
                    }

                    const userIndex = ALL_USERS.findIndex(u => u.id == userId);
                    
                    if (userIndex !== -1) {
                        const user = ALL_USERS[userIndex];
                        user.password = newPwd; // å„²å­˜æ˜æ–‡å¯†ç¢¼
                        
                        try {
                            localStorage.setItem(`userPassword_${user.id}`, user.password);
                        } catch (e) {
                            console.error("ç„¡æ³•å„²å­˜å¯†ç¢¼åˆ° localStorage:", e);
                        }

                        if (user.isRegistration) {
                            let storedRealUsers = [];
                            try {
                                const storedData = localStorage.getItem('userManagementData');
                                storedRealUsers = storedData ? JSON.parse(storedData) : [];
                            } catch (e) {
                                console.error("Error parsing userManagementData for password update:", e);
                            }
                            
                            const realUserIndex = storedRealUsers.findIndex(u => u.id == userId);
                            if (realUserIndex !== -1) {
                                storedRealUsers[realUserIndex].password = user.password;
                                try {
                                    localStorage.setItem('userManagementData', JSON.stringify(storedRealUsers));
                                } catch (e) {
                                    console.error("ç„¡æ³•æ›´æ–° userManagementData:", e);
                                }
                            }
                        }
                        
                        alert(`ä½¿ç”¨è€… ${user.name} çš„å¯†ç¢¼å·²è®Šæ›´æˆåŠŸï¼`);
                        
                        renderUserTable(ALL_USERS); 
                        closePasswordModal();
                    } else {
                        alert('æ‰¾ä¸åˆ°è©²ä½¿ç”¨è€…ã€‚');
                    }
                });
            }
            
            const closePasswordModalBtn = document.getElementById('closePasswordModalBtn');
            if(closePasswordModalBtn) {
                closePasswordModalBtn.addEventListener('click', closePasswordModal);
            }

            const adminPasswordForm = document.getElementById('adminPasswordForm');
            if (adminPasswordForm) {
                adminPasswordForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const newPwd = document.getElementById('newAdminPassword').value;
                    const confirmPwd = document.getElementById('confirmAdminPassword').value;
                    
                    if (newPwd !== confirmPwd) {
                        alert('å…©æ¬¡è¼¸å…¥çš„æ–°å¯†ç¢¼ä¸ä¸€è‡´ï¼');
                        return;
                    }
                    if (newPwd.length < 6) {
                        alert('å¯†ç¢¼é•·åº¦å¿…é ˆè‡³å°‘ç‚º 6 ä½ã€‚');
                        return;
                    }
                    
                    try {
                        sessionStorage.setItem('adminPassword', newPwd);
                        alert('æ‚¨çš„ç®¡ç†è€…å¯†ç¢¼å·²æˆåŠŸè®Šæ›´ï¼\n(è«‹æ³¨æ„ï¼šæ¨¡æ“¬ç™»å…¥ç”¨çš„å¯†ç¢¼ 123456 ä¸æœƒè¢«ä¿®æ”¹)');
                    } catch (e) {
                         alert('éŒ¯èª¤ï¼šç„¡æ³•å„²å­˜æ–°å¯†ç¢¼åˆ° sessionStorageã€‚');
                    }
                    
                    document.getElementById('adminPasswordForm').reset();
                });
            }

            const adminProfileForm = document.getElementById('adminProfileForm');
            if (adminProfileForm) {
                adminProfileForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const newAccount = document.getElementById('adminAccount').value;
                    const newEmail = document.getElementById('adminEmail').value;
                    alert(`(æ¨¡æ“¬) ç®¡ç†è€…è³‡æ–™å·²æ›´æ–°ï¼\nå¸³è™Ÿ: ${newAccount}\nEmail: ${newEmail}`);
                });
            }

            const secondAdminForm = document.getElementById('secondAdminForm');
            if (secondAdminForm) {
                secondAdminForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    alert('(æ¨¡æ“¬) å·²å‰µå»ºç¬¬äºŒç®¡ç†è€…å¸³æˆ¶ï¼\n(æ­¤åŠŸèƒ½éœ€è¦çœŸå¯¦å¾Œç«¯è³‡æ–™åº«æ”¯æ´æ¬Šé™ç®¡ç†)');
                });
            }

            // --- é è¨­è¼‰å…¥ ---
            // ğŸ’¡ ç¢ºä¿é è¨­è¼‰å…¥çš„ 'analytics' æ˜¯å®‰å…¨çš„
            switchTab('analytics');
        });

    </script>

</body>
</html>